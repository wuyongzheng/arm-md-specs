## G1.15 Exception return to an Exception level using AArch32

In the Arm architecture, exception return to an Exception level that is using AArch32 requires the simultaneous restoration of the PC and PSTATE to values that are consistent with the desired state of execution on returning from the exception. Typically, exception return involves returning to one of:

- The instruction after the instruction boundary at which an asynchronous exception was taken.
- The instruction following an SVC , SMC , or HVC instruction, for an exception generated by one of those instructions.
- The instruction that caused the exception, after the reason for the exception has been removed.
- The subsequent instruction, if the instruction that caused the exception has been emulated in the exception handler.

The Arm architecture defines a preferred return address for each exception other than Reset, see Link values saved on exception entry. The values of the SPSR.IT[7:0] bits generated on exception entry are always correct for this preferred return address, but might require adjustment by the exception handler if returning elsewhere.

In some cases, to calculate the appropriate preferred return address for a return to an Exception level that is using AArch32, a subtraction must be performed on the link value saved on taking the exception. The description of each exception includes any value that must be subtracted from the link value, and other information about the required exception return.

On an exception return, the PSTATE takes either:

- The value loaded by the RFE instruction.
- If the exception return is not performed by executing an RFE instruction, the value of the current SPSR at the time of the exception return.

If FEAT\_MTE is implemented PSTATE.TCO is not updated on Exception return to AArch32 state.

Illegal return events from AArch32 state describes the behavior if the restored PE state would not be valid for the Exception level, PE mode, and Security state targeted by the exception return.

## G1.15.1 Exception return instructions

The instructions that an exception handler can use to return from an exception depend on whether the exception was taken to an EL1 mode, or in an EL2 mode, see:

- Return from an exception taken to a PE mode other than Hyp mode.
- Return from an exception taken to Hyp mode.

## G1.15.1.1 Return from an exception taken to a PE mode other than Hyp mode

For an exception taken to a PE mode other than Hyp mode, the Arm AArch32 architecture provides the following exception return instructions :

- From privileged modes other than System mode, the ERET instruction. After the exception return, execution resumes from the address held in the LR (R14) for the mode in which ERET is executed. See ERET.

- Data-processing instructions with the S bit set and the PC as a destination, see MOV , MOVS (register) and SUB, SUBS (immediate).

Note

The A32 instruction set includes other instructions that can be used for an exception return, but Arm deprecates any use of those instructions.

Typically:

- Areturn where no subtraction is required uses SUBS with an operand of 0, or the equivalent MOVS instruction.

- Areturn requiring subtraction uses SUBS with a nonzero operand.

- The RFE instruction, see RFE, RFEDA, RFEDB, RFEIA, RFEIB. If a subtraction is required, typically it is performed before saving the LR value to memory. After the exception return, execution resumes from the address held in the memory location indicated by the base register specified by the RFE instruction.
- In A32 state, a form of the LDM instruction in which the PC is one of the registers loaded, see LDM (exception return). If a subtraction is required, typically it is performed before saving the LR value to memory.

## G1.15.1.2 Return from an exception taken to Hyp mode

For an exception taken to Hyp mode, the Arm architecture provides the ERET instruction, see ERET. An exception handler executing in Hyp mode must return using the ERET instruction.

Hyp mode is implemented only as part of EL2.

## G1.15.2 Alignment of exception returns

The T bit of the value transferred to the PSTATE by an exception return controls the target instruction set of that return. The behavior of the hardware for exception returns for different values of the T bit is as follows:

- T==0 The target instruction set state is A32 state. Bits[1:0] of the address transferred to the PC are ignored by the hardware.
- T==1 The target instruction set state is T32 state:
- Bit[0] of the address transferred to the PC is ignored by the hardware.
- Bit[1] of the address transferred to the PC is part of the instruction address.

Note

In previous versions of the Arm architecture, the PSTATE.{J, T} bits determined the Instruction set state. From the introduction of Armv8, PSTATE.J is RES0.

Arm deprecates any dependence on the requirements that the hardware ignores bits of the address. Arm recommends that the address transferred to the PC for an exception return is correctly aligned for the target instruction set.

After an exception entry other than Reset, the LR value has the correct alignment for the instruction set indicated by the SPSR.T bit. This means that if exception return instructions are used with the LR and SPSR values produced by such an exception entry, the only precaution software needs to take to ensure correct alignment is that any subtraction is of a multiple of four if returning to A32 state, or a multiple of two if returning to T32 state.

## G1.15.3 Illegal return events from AArch32 state

Throughout this section:

Return

In AArch32 state, refers to any of:

- Execution of any exception return instruction.
- Execution of a DRPS instruction in Debug state.
- Exit from Debug state.

If an exception or debug return from an Exception level using AArch32 triggers an illegal exception return, then bit[1] of the PC is either:

- Zero.
- The value of bit[1] of the return address for the exception or debug return.

The choice between these two alternatives is made by the implementation, and might differ from instance to instance of an illegal exception return.

Note

This means software must support both alternatives.

Saved process state value

In AArch32 state, refers to any of:

- The value held in the SPSR for any exception return other than an exception return made by executing an RFE instruction.
- The value read from memory that is to be restored to PSTATE by the execution of an RFE instruction.
- The value held in the SPSR for the execution of a DRPS instruction in Debug state.
- The value held in the DSPSR for a Debug state exit.

## Link address In AArch32 state, refers to any of:

- The address held in the link register for any exception return other than an exception return made by executing an ERET , LDM , or RFE instruction.
- The address held in ELR\_hyp for any exception return made by executing an ERET instruction.
- The address read from memory that is to be restored to the PC by the execution of an LDM or RFE instruction.
- The address held in the DLR for Debug state exit.

## Configured from reset

Indicates the state determined on powerup or reset by a configuration input signal, or by another IMPLEMENTATION DEFINED mechanism.

The architecture has a generic mechanism for handling exception or debug returns to a mode or state that is illegal. In AArch32 state, this can occur as a result of any of the following situations:

- Areturn where the Exception level being returned to is higher than the current Exception level.
- Areturn where the mode being returned to is not implemented. For example:
- -Areturn to Hyp mode when EL2 is not implemented.
- -Areturn to Monitor mode, when EL3 is either not implemented or using AArch64 state.
- Areturn to EL2 when:
- -EL3 is implemented and using AArch64, and the values of SCR\_EL3.{NS, EEL2} 0.
- -EL3 is implemented and using AArch32, and the value of the SCR.NS bit is 0.
- Areturn to Non-secure EL1 when:
- -EL2 is implemented and using AArch64, and the value of the HCR\_EL2.TGE bit is 1.
- -EL2 is implemented and using AArch32, and the value of the HCR.TGE bit is 1.
- Areturn where the value of the saved process state M[4:0] field is not a valid AArch32 PE mode for the implementation. Table G1-5 shows the valid M[4:0] values for AArch32 PE modes.

## In these cases:

- PSTATE.IL is set to 1, to indicate an illegal return.
- PSTATE.M is unchanged. This means the PE mode does not change.
- The SS bit is handled in the same way as any other exception or debug return, see Software Step exceptions.
- The following PSTATE bits are restored from the saved process state value:
- -The N, Z, C, V Condition flags.
- -The Q Overflow or saturation flag.
- -The GE Greater than or Equal flags.
- -The E Endianness mapping bit.
- -The A, I, F exception mask bits.
- -The DIT Data Independent Timing bit.
- The PSTATE.{IT, T} bits are each either:
- -Set to 0.
- -Copied from the saved process state in the SPSR for the PE mode in which the exception is handled.

The choice between these two options is determined by an implementation, and might vary dynamically within an implementation. Correspondingly software must regard the value as being an UNKNOWN choice between the two values.

- The PC is restored from the link address, unless the illegal return is the execution of a DRPS instruction in Debug state.

When the value of the PSTATE.IL bit is 1, any attempt to execute any instruction results in an Illegal Execution state exception. See The Illegal Execution state exception.

All aspects of the illegal return, other than the effects described in this section, are the same as for a legal return.

## G1.15.4 Legal returns that set PSTATE.IL to 1

In this section, return, saved process state value, and link address have the meaning that is defined in Illegal return events from AArch32 state.

If the IL bit in the saved process state value is 1, then it is copied to PSTATE meaning that PSTATE.IL is set to 1. In this case, the PSTATE.{IT, T} bits are each either:

- Set to 0.
- Copied from the SPSR, or loaded from memory if the exception return was performed by executing an RFE instruction.

The choice between these two options is determined by an implementation, and might vary dynamically within the implementation. This means software must regard each value as being an UNKNOWN choice between the two permitted values.

Because the return sets the PSTATE.IL bit to 1, any attempt to execute any instruction results in an Illegal Execution state exception. See The Illegal Execution state exception.

## G1.15.5 The Illegal Execution state exception

When the value of the PSTATE.IL bit is 1, any attempt to execute an instruction generates an Illegal Execution state exception. In AArch32 state, the PSTATE.IL bit can be set to 1 by one of the following:

- An illegal return, as described in Illegal return events from AArch32 state.
- An illegal change to PSTATE.M, as described in Illegal changes to PSTATE.M.
- Alegal return that sets PSTATE.IL to 1, as described in Legal returns that set PSTATE.IL to 1.

An Illegal Execution state exception is taken in the same way as an Undefined Instruction exception in the current Exception level. If the current Exception level is EL2 using AArch32 state, the HSR provides additional syndrome information for the exception, see Use of the HSR.

An Illegal Execution state exception has priority over any other Undefined Instruction exception that might arise from instruction execution.

Note

This section only describes the handling of an Illegal Execution state exception that is taken to an Exception level that is using AArch32 state.

On taking any exception to an Exception level that is using AArch32 state:

1. The value of the PSTATE.IL bit is 1 and this is copied to the SPSR.IL bit for the PE mode to which the exception is taken.
2. The PSTATE.IL bit is cleared to 0.

Note

This means that it is not possible for software to observe the value of PSTATE.IL.

## G1.15.5.1 Pseudocode description of exception return

The AArch32.ExceptionReturn() function transfers the return address to the PC and restores PSTATE to its saved value.

This function uses the function SetPSTATEFromPSR() .

The IllegalExceptionReturn() function checks for an Illegal Execution state exception.

A-profile Architecture Pseudocode includes the definitions of these functions.