## D6.5 Trace buffer management

IGYHBH

IFZXSV

INFZKS

RHLKSG

RBNQRP

FEAT\_TRBE supports the following trace buffer modes:

## Circular Buffer mode

In Circular Buffer mode, when the current write pointer reaches the Limit pointer , it is wrapped by setting it to the Base pointer .

## Wrap mode

Fill mode

As Wrap mode, except that trace collection stops when the current write pointer is wrapped.

The trace buffer mode is controlled by TRBLIMITR\_EL1.FM.

Atrace buffer management event occurs:

- On an Alignment fault or MMU fault.
- On an External abort.
- On a Trigger Event , if enabled.
- When the current write pointer is wrapped to the Base pointer and the trace buffer mode is not Circular Buffer mode. This event is known as:
- -Abuffer wrap event, if the trace buffer mode is Wrap mode.
- -Abuffer full event, if the trace buffer mode is Fill mode.
- On a programming error, when permitted as an UNPREDICTABLE behavior of the PE. For more information, see Restrictions on programming the Trace Buffer Unit and UNPREDICTABLE behavior.
- On an IMPLEMENTATION DEFINED event.

Note

The trace buffer management event behavior differs from that of the SPE Profiling Buffer management event.

On a trace buffer management event, all of the following occurs:

- The interrupt request bit, TRBSR\_ELx.IRQ, is set to 1.
- Additional syndrome for the event might be written to TRBSR\_ELx.MSS.

The value of ELx depends on the type of event, and is defined by RBNQRP. The other fields in TRBSR\_ELx and the other TRBSR\_ELx registers are unchanged.

If FEAT\_TRBE\_EXC is implemented and self-hosted trace is enabled, then when a trace buffer management event is generated:

- If EL3 is implemented and any of the following are true, then the management event is recorded in TRBSR\_EL3:
- -MDCR\_EL3.TRBEE is 0b11 .
- -MDCR\_EL3.TRBEE is 0b10 and the management event is due to a fault on a write to the trace buffer that would generate a Data Abort exception taken to EL3 if generated by a store instruction executed at the owning Exception level. That is, any of the following faults on a write to the trace buffer:
- -Granule Protection Check (GPC) faults, other than Granule Protection Faults (GPFs). For more information, see Granule Protection Check faults.
- -If SCR\_EL3.GPF is 1, GPFs.
- -If SCR\_EL3.EA is 1, External aborts. See also IFRNZK.
- Otherwise, if all of the following are true, then the management event is recorded in TRBSR\_EL2:
- -EL3 is not implemented or MDCR\_EL3.TRBEE is not 0b00 .
- -EL2 is implemented and any of the following are true:
- -The Effective value of SCR\_EL3.NS is 1.
- -The Effective value of SCR\_EL3.{NS, EEL2} is {0, 1}.

This applies even when the current Exception level is EL3.

- -One of the following is true:
- -TRFCR\_EL2.EE is 0b11 .

As Circular Buffer mode, except that an interrupt request is generated when the current write pointer is wrapped.

- -TRFCR\_EL2.EE is 0b10 and the management event is due to any fault on a write to the trace buffer that would generate a Data Abort exception taken to EL2 if generated by a store instruction executed at the owning Exception level.

If the owning Exception level is EL2, this means any fault on a write to the trace buffer. If the owning Exception level is EL1, this means any of the following faults on a write to the trace buffer:

- ꞏ Stage 2 faults.
- ꞏ If HCR\_EL2.GPF is 1, GPFs.
- ꞏ If HCR\_EL2.TEA is 1, External aborts. See also IFRNZK.
- -TRFCR\_EL2.EE is 0b10 and the management event is due to a GPC fault other than a GPF.
- Otherwise, the management event is recorded in TRBSR\_EL1.

If FEAT\_TRBE\_EXC is not implemented or self-hosted trace is disabled, then the management event is recorded in TRBSR\_EL1.

The pseudocode function ReportTRBEEvent() shows this.

- IFRNZK From Armv9.3, External aborts are not reported on writes to the trace buffer. However, External aborts on translation table walks, translation table updates, and GPT walks can be reported as MMU faults. See Faults.

Table D6-5, Table D6-6, and Table D6-7 show which TRBSR\_ELx register used to record the syndrome for each type of

- IKKVYZ trace buffer management event when self-hosted trace is enabled.

Each column in the left side of the tables refers to the Effective value of a field in a System register. Each column in the right side of the tables represents a trace buffer management event:

## Other event

## Stage 1 (GPF)

Means a trace buffer management event for a Granule Protection Fault (GPF) reported as a stage 1 abort on a write to the buffer, recorded with the EC value of 0b100100 and an FSC value indicating a GPF.

## Stage 1 (External abort)

Means a trace buffer management event for an External abort reported as a stage 1 abort on a write to the buffer, recorded with the EC value of 0b100100 and an FSC value indicating an External abort.

## Stage 1 (Other abort)

Means a trace buffer management event for any other stage 1 abort on a write to the buffer, recorded with the EC value 0b100100 .

## Stage 2 (GPF)

Means a trace buffer management event for a GPF reported as a stage 2 abort on a write to the buffer, recorded with the EC value of 0b100101 and an FSC value indicating a GPF.

## Stage 2 (External abort)

Means a trace buffer management event for an External abort reported as a stage 2 abort on a write to the buffer, recorded with the EC value of 0b100101 and an FSC value indicating an External abort. That is, a synchronous External abort on a stage 2 translation table walk or translation table update.

## Stage 2 (Other abort)

Means a trace buffer management event for any other stage 2 abort on a write to the buffer, recorded with the EC value 0b100101 .

## GPCfault

Means a trace buffer management event for a Granule Protection Check fault, other than a GPF, on a write to the buffer, recorded with the EC value 0b011110 .

The values in each of these cells denotes which TRBSR\_ELx register is updated for that combination of control register values and trace buffer management event type.

Means a trace buffer management event recorded with the EC value 0b000000 .

## Table D6-5 TRBE Profiling Buffer management event reporting (Granule Protection Checks)

| MDCR_EL3.TRBEE   | SCR_EL3.GPF   | TRFCR_EL2.EE   | MDCR_EL2.E2TB   | HCR_EL2.GPF   | GPF Stage 1   | Stage 2   | GPC fault   |
|------------------|---------------|----------------|-----------------|---------------|---------------|-----------|-------------|
| 0b00             | X             | XX             | XX              | X             | EL1           | EL1       | EL1         |
| 0b01             | X             | 0b0X           | XX              | X             | EL1           | EL1       | EL1         |
| 0b01             | X             | 0b10           | 0b00            | X             | EL2           | EL2       | EL2         |
| 0b01             | X             | 0b10           | 0b1X            | 0b0           | EL1           | EL2       | EL2         |
| 0b01             | X             | 0b10           | 0b1X            | 0b1           | EL2           | EL2       | EL2         |
| 0b01             | X             | 0b11           | XX              | X             | EL2           | EL2       | EL2         |
| 0b10             | 0b0           | 0b0X           | XX              | X             | EL1           | EL1       | EL3         |
| 0b10             | 0b0           | 0b10           | 0b00            | X             | EL2           | EL2       | EL3         |
| 0b10             | 0b0           | 0b10           | 0b1X            | 0b0           | EL1           | EL2       | EL3         |
| 0b10             | 0b0           | 0b10           | 0b1X            | 0b1           | EL2           | EL2       | EL3         |
| 0b10             | 0b0           | 0b11           | XX              | X             | EL2           | EL2       | EL3         |
| 0b10             | 0b1           | XX             | XX              | X             | EL3           | EL3       | EL3         |
| 0b11             | X             | XX             | XX              | X             | EL3           | EL3       | EL3         |

## Table D6-6 TRBE Profiling Buffer management event reporting (External aborts)

| MDCR_EL3.TRBEE   | SCR_EL3.EA   | TRFCR_EL2.EE   | MDCR_EL2.E2TB   | HCR_EL2.TEA   | External abort   | External abort   |
|------------------|--------------|----------------|-----------------|---------------|------------------|------------------|
|                  |              |                |                 |               | Stage 1          | Stage 2          |
| 0b00             | X            | XX             | XX              | X             | EL1              | EL1              |
| 0b01             | X            | 0b0X           | XX              | X             | EL1              | EL1              |
| 0b01             | X            | 0b10           | 0b00            | X             | EL2              | EL2              |
| 0b01             | X            | 0b10           | 0b1X            | 0b0           | EL1              | EL2              |
| 0b01             | X            | 0b10           | 0b1X            | 0b1           | EL2              | EL2              |
| 0b01             | X            | 0b11           | XX              | X             | EL2              | EL2              |
| 0b10             | 0b0          | 0b0X           | XX              | X             | EL1              | EL1              |
| 0b10             | 0b0          | 0b10           | 0b00            | X             | EL2              | EL2              |
| 0b10             | 0b0          | 0b10           | 0b1X            | 0b0           | EL1              | EL2              |
| 0b10             | 0b0          | 0b10           | 0b1X            | 0b1           | EL2              | EL2              |
| 0b10             | 0b0          | 0b11           | XX              | X             | EL2              | EL2              |
| 0b10             | 0b1          | XX             | XX              | X             | EL3              | EL3              |
| 0b11             | X            | XX             | XX              | X             | EL3              | EL3              |

Table D6-7 TRBE Profiling Buffer management event reporting (All other management events)

| MDCR_EL3.TRBEE   | TRFCR_EL2.EE   | MDCR_EL2.E2TB   | Other abort   | Other abort   | Other event   |
|------------------|----------------|-----------------|---------------|---------------|---------------|
| MDCR_EL3.TRBEE   | TRFCR_EL2.EE   | MDCR_EL2.E2TB   | Stage 1       | Stage 2       | Other event   |
| 0b00             | XX             | XX              | EL1           | EL1           | EL1           |
| 0b01             | 0b0X           | XX              | EL1           | EL1           | EL1           |
| 0b01             | 0b10           | 0b00            | EL2           | EL2           | EL1           |
| 0b01             | 0b10           | 0b1X            | EL1           | EL2           | EL1           |
| 0b01             | 0b11           | XX              | EL2           | EL2           | EL2           |
| 0b10             | 0b0X           | XX              | EL1           | EL1           | EL1           |
| 0b10             | 0b10           | 0b00            | EL2           | EL2           | EL1           |
| 0b10             | 0b10           | 0b1X            | EL1           | EL2           | EL1           |
| 0b10             | 0b11           | XX              | EL2           | EL2           | EL2           |
| 0b11             | XX             | XX              | EL3           | EL3           | EL3           |

## RMFMXQ

When FEAT\_TRBE\_EXC is implemented, self-hosted trace is enabled, and any of the following are true, then the TRBE Profiling exception is enabled and pending:

- All of the following are true:
- -EL3 is implemented.
- -MDCR\_EL3.TRBEE is 0b10 or 0b11 .
- -TRBSR\_EL3.IRQ is 1.

## In this case:

- -The target Exception level is EL3.
- -If all of the following are true, then the TRBE Profiling exception is unmasked :
- -The PE is executing at EL2, EL1, or EL0.
- -The PE is in Non-debug state.
- All of the following are true:
- -EL3 is not implemented or MDCR\_EL3.TRBEE is not 0b00 .
- -EL2 is implemented and enabled in the current Security State.
- -TRFCR\_EL2.EE is 0b10 or 0b11 .
- -TRBSR\_EL2.IRQ is 1.

## In this case:

- -The target Exception level is EL2.
- -If the PE is executing in the owning Security state, the PE is in Non-debug state, and any of the following are true, then the TRBE Profiling exception is unmasked:
- -The PE is executing at EL1 or EL0.
- -The PE is executing at EL2, TRFCR\_EL2.EE is 0b11 , TRFCR\_EL2.KE is 1, and PSTATE.PM is 0.
- All of the following are true:
- -EL3 is not implemented or MDCR\_EL3.TRBEE is not 0b00 .
- -EL2 is not implemented, or EL2 is disabled in the current Security State, or TRFCR\_EL2.EE is not 0b00 .
- -TRFCR\_EL1.EE is 0b11 .
- -TRBSR\_EL1.IRQ is 1.

## In this case:

- -The target Exception level is EL2 if the Effective value of HCR\_EL2.TGE is 1, and EL1 otherwise.
- -If the PE is executing in the owning Security state, the PE is in Non-debug state, and any of the following are true, then the TRBE Profiling exception is unmasked.
- -The PE is executing at EL0.
- -The PE is executing at EL1, TRFCR\_EL1.KE is 1, and PSTATE.PM is 0.

When self-hosted trace is disabled or none of the above apply, the TRBE Profiling exception is disabled and not pending.

IMTLSX

When the TRBE Profiling exception is enabled and unmasked, the TRBE Profiling exception will be taken to the target Exception level.

When the TRBE Profiling exception is enabled and not unmasked, then the TRBE Profiling exception is masked . The TRBE Profiling exception is always masked at EL3.

The pseudocode function CheckForTRBEException() shows this.

Table D6-8, Table D6-9, and Table D6-10 show the TRBE Profiling exception enable and masking for each Exception level, for each of the TRBSR\_EL1.IRQ, TRBSR\_EL2.IRQ, and TRBSR\_EL3.IRQ bits respectively when all of the following apply:

- FEAT\_TRBE\_EXC is implemented.
- The PE is executing in AArch64 state.
- Self-hosted trace is enabled.

Each column in the left side of the table refers to the Effective value of a field in a System register or PSTATE. In Table D6-8, the IRQ column represents the state of the TRBIRQ signal. In these cells for each row representing a combination of control bits:

## HIGH

## LOW

Means the TRBE Profiling exception is disabled and the TRBE interrupt request is enabled and asserted.

Means the TRBE interrupt request is not asserted.

The other columns in the right side of each table represent an Exception level the exception is taken from. In each cell for each of these columns for each row representing a combination of control bits:

## None

B

C

ELx n/a

Means the exception is disabled. For Table D6-9 and Table D6-10 this means that the TRBSR\_EL3.IRQ or TRBSR\_EL2.IRQ bit (as applicable) is ignored

Means the exception is enabled and masked by PSTATE.PM. The exception remains pending.

Means the exception is enabled and masked regardless of the value of PSTATE.PM. The exception remains pending.

Means the exception is enabled, is not masked, and is taken to ELx.

Not applicable. The PE cannot be executing at this Exception level for the specified value of HCR\_EL2.TGE.

## Table D6-8 TRBE Profiling exception and interrupt, taken from EL0, EL1, EL2 or EL3, when the Effective value of TRBSR\_EL1.IRQ is 1

| MDCR_EL3. TRBEE   | TRFCR_EL2. EE   | HCR_EL2. TGE   | TRFCR_EL1   |     | PSTATE. PM   | IRQ   | Taken from   | Taken from   |      |      |
|-------------------|-----------------|----------------|-------------|-----|--------------|-------|--------------|--------------|------|------|
| MDCR_EL3. TRBEE   | TRFCR_EL2. EE   | HCR_EL2. TGE   | EE          | KE  |              |       | EL0          | EL1          | EL2  | EL3  |
| 0b00              | XX              | 0b0            | XX          | X   | X            | HIGH  | None         | None         | None | None |
| 0b00              | XX              | 0b1            | XX          | X   | X            | HIGH  | None         | n/a          | None | None |
| !=0b00            | 0b00            | 0b0            | XX          | X   | X            | HIGH  | None         | None         | None | None |
| !=0b00            | 0b00            | 0b1            | XX          | X   | X            | HIGH  | None         | n/a          | None | None |
| !=0b00            | !=0b00          | 0b0            | 0b0X        | X   | X            | HIGH  | None         | None         | None | None |
| !=0b00            | !=0b00          | 0b0            | 0b1X        | 0b0 | X            | LOW   | EL1          | C            | C    | C    |
| !=0b00            | !=0b00          | 0b0            | 0b1X        | 0b1 | 0b0          | LOW   | EL1          | EL1          | C    | C    |
| !=0b00            | !=0b00          | 0b0            | 0b1X        | 0b1 | 0b1          | LOW   | EL1          | B            | C    | C    |

| MDCR_EL3. TRBEE   | TRFCR_EL2. EE   | HCR_EL2. TGE   | TRFCR_EL1   |    | PSTATE. PM   | IRQ   | Taken from   | Taken from   |      |      |
|-------------------|-----------------|----------------|-------------|----|--------------|-------|--------------|--------------|------|------|
| MDCR_EL3. TRBEE   | TRFCR_EL2. EE   | HCR_EL2. TGE   | EE          | KE |              |       | EL0          | EL1          | EL2  | EL3  |
| !=0b00            | !=0b00          | 0b1            | 0b0X        | X  | X            | HIGH  | None         | n/a          | None | None |
| !=0b00            | !=0b00          | 0b1            | 0b1X        | X  | X            | LOW   | EL2          | n/a          | C    | C    |

## Table D6-9 TRBE Profiling exception, taken from EL0, EL1, EL2 or EL3, when the Effective value of TRBSR\_EL2.IRQ is 1

| MDCR_EL3.TRBEE   | TRFCR_EL2   | TRFCR_EL2   | HCR_EL2.TGE   | PSTATE.PM   | Taken from   | Taken from   |      |      |
|------------------|-------------|-------------|---------------|-------------|--------------|--------------|------|------|
|                  | EE          | KE          |               |             | EL0          | EL1          | EL2  | EL3  |
| 0b00             | XX          | X           | 0b0           | X           | None         | None         | None | None |
| 0b00             | XX          | X           | 0b1           | X           | None         | n/a          | None | None |
| !=0b00           | 0b0X        | X           | 0b0           | X           | None         | None         | None | None |
| !=0b00           | 0b0X        | X           | 0b1           | X           | None         | n/a          | None | None |
| !=0b00           | 0b10        | X           | 0b0           | X           | EL2          | EL2          | C    | C    |
| !=0b00           | 0b10        | X           | 0b1           | X           | EL2          | n/a          | C    | C    |
| !=0b00           | 0b11        | 0b0         | 0b0           | X           | EL2          | EL2          | C    | C    |
| !=0b00           | 0b11        | 0b0         | 0b1           | X           | EL2          | n/a          | C    | C    |
| !=0b00           | 0b11        | 0b1         | 0b0           | 0b0         | EL2          | EL2          | EL2  | C    |
| !=0b00           | 0b11        | 0b1         | 0b0           | 0b1         | EL2          | EL2          | B    | C    |
| !=0b00           | 0b11        | 0b1         | 0b1           | 0b0         | EL2          | n/a          | EL2  | C    |
| !=0b00           | 0b11        | 0b1         | 0b1           | 0b1         | EL2          | n/a          | B    | C    |

## Table D6-10 TRBE Profiling exception, taken from EL0, EL1, EL2 or EL3, when the Effective value of TRBSR\_EL3.IRQ is 1

| MDCR_EL3.TRBEE   | HCR_EL2.TGE   | Taken from   | Taken from   |      |      |
|------------------|---------------|--------------|--------------|------|------|
|                  |               | EL0          | EL1          | EL2  | EL3  |
| 0b0X             | 0b0           | None         | None         | None | None |
| 0b0X             | 0b1           | None         | n/a          | None | None |
| 0b10             | 0b0           | EL3          | EL3          | EL3  | C    |
| 0b10             | 0b1           | EL3          | n/a          | EL3  | C    |
| 0b11             | 0b0           | EL3          | EL3          | EL3  | C    |
| 0b11             | 0b1           | EL3          | n/a          | EL3  | C    |

IWKGWP

ATRBEProfiling exception is never generated when self-hosted trace is disabled. This includes when FEAT\_TRBE\_EXT is implemented and the Trace Buffer Unit is in External mode.

IPRSXC

By setting MDCR\_EL3.TRBEE or TRFCR\_EL2.EE to 0b01 , software at EL3 or EL2 (respectively) allows lower Exception levels to use the TRBE Profiling exception without any trace buffer management event being recorded in TRBSR\_EL3 or TRBSR\_EL2, meaning no TRBE Profiling exceptions are taken to EL3 or EL2 (as applicable).

|         | However, this also means that the lower Exception level has visibility of when writes to the trace buffer cause a Granule Protection Check fault, Granule Protection Fault, or stage 2 MMUfault (as applicable). Note that this is also true in FEAT_TRBE when FEAT_TRBE_EXC is not implemented. If both MDCR_EL3.TRBEE and TRFCR_EL2.EE are 0b01 , then all trace buffer management events are recorded in TRBSR_EL1, as in FEAT_TRBE when FEAT_TRBE_EXC is not implemented. Depending on the value of TRFCR_EL1.EE, the recorded event might generate a TRBE Profiling exception taken to EL1, or cause TRBIRQ to be asserted.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
|---------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| I HWBCW | By setting MDCR_EL3.TRBEE and/or TRFCR_EL2.EE to 0b10 , software at EL3 and/or EL2 (respectively) allows lower Exception levels to use the TRBE Profiling exception or trace buffer interrupt. Only trace buffer management events related to memory management by that Exception level recorded in TRBSR_EL3 or TRBSR_EL2, with EL3 having priority. This means that only TRBE Profiling exceptions for those events are taken to EL3 or EL2. This allows trace buffer management events for aborts on writes to the trace buffer to be routed directly to the same software that would handle a similar Data Abort exception on a store instruction. R BNQRP describes which trace buffer management events these are. Software at the higher Exception level can inject those events into a lower Exception level by writing TRBSR_ELx for the lower Exception level. For example, after triaging the event. This will generate either a TRBE Profiling exception or trace buffer interrupt, depending on the value of TRFCR_ELx.EE. R BNQRP means that a lower Exception level cannot create a fake trace buffer management event for a higher Exception level. |
| I CFYMJ | If MDCR_EL3.TRBEE is 0b01 and TRFCR_EL2.EE is 0b10 , then a hybrid of I PRSXC and I HWBCW is used. This allows EL3 software to enable use of FEAT_TRBE_EXC with minimal changes from FEAT_TRBE, with EL2 managing trace buffer management events that should not be handled by the Guest operating system.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| I TCNHM | By setting MDCR_EL3.TRBEE or TRFCR_EL2.EE to 0b11 , software at EL3 or EL2 (respectively) forces all trace buffer management events to be recorded in TRBSR_EL3 or TRBSR_EL2, meaning TRBE Profiling exceptions for trace buffer management events are taken to EL3 or EL2 (as applicable), with EL3 having priority. Software at EL3 or EL2 can inject those events into a lower Exception level by writing TRBSR_ELy for the lower Exception level. For example, after triaging the event.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| I QPKBN | The target Exception level might be the same as the owning Exception level, or a higher Exception level, or a lower Exception level. For example:                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| R YXTTY | When a TRBE Profiling exception is enabled and unmasked, and all of the following are true, the TRBE Profiling exception will be taken before an instruction C completes execution:                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| I PZBKW | TRBE Profiling exceptions are treated in the same way as other Profiling exceptions by FEAT_ETE and FEAT_BRBE, if implemented. Note                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| R VSCDV | If any of the following are true, then the TRBE interrupt request ( TRBIRQ ) is enabled and driven from                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |

- FEAT\_TRBE\_EXC is not implemented.
- EL3 is implemented and MDCR\_EL3.TRBEE is 0b00 .
- EL2 is implemented, TRFCR\_EL2.EE is 0b00 , and any of the following are true:
- -The Effective value of SCR\_EL3.NS is 1.
- -The Effective value of SCR\_EL3.{NS, EEL2} is {0, 1}.

This applies even when the current Exception level is EL3.

- TRFCR\_EL1.EE is 0b00 .
- Self-hosted trace is disabled.

Otherwise, if FEAT\_TRBE\_EXC is implemented, then the TRBE interrupt request is disabled and driven LOW (inactive).

The pseudocode function TRBEInterruptEnabled() shows this.

| D LRTBP   | TRBIRQ is a level-triggered interrupt request.                                                                                                                                                                                                                                                                                                                                        |
|-----------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| R TPPCF   | When a GIC is implemented, TRBIRQ is configured as a PPI. TRBIRQ is signaled by the PE that implements the Trace Buffer Unit.                                                                                                                                                                                                                                                         |
| I HHRLX   | The PPI number is not defined by the architecture. Arm recommends that the PPI number is discoverable to an Operating System, for example using ACPI or devicetree interfaces.                                                                                                                                                                                                        |
| S XLNJY   | Software must configure the trace buffer management interrupt to be taken to the correct Exception level.                                                                                                                                                                                                                                                                             |
| I HJFLC   | Buffer full, Alignment fault, and MMUfault trace buffer management events are synchronous. This means that the effect of these trace buffer management events setting TRBSR_EL1.S to 1, collection is stopped, happens before any further trace is collected by the Trace Buffer Unit from the trace unit.                                                                            |
| I JLZDN   | When the trigger mode is Stop on Trigger , a Trigger Event initiates a trace unit flush meaning more trace might be written to the trace buffer before any collection is stopped by the Trigger Event trace buffer management event. This additional trace might cause a second trace buffer management event to be generated before the Trigger Event trace buffer management event. |
| I ZLVHR   | TRBE Profiling exceptions and the TRBIRQ interrupt are always taken asynchronously and precisely by the PE, even if the event is reported synchronously to the Trace Buffer Unit.                                                                                                                                                                                                     |
| I GVGPB   | Following an Alignment fault, MMUfault, or External abort trace buffer management event, TRBPTR_EL1 serves as a Fault Address Register.                                                                                                                                                                                                                                               |
|           | For a fault or synchronous External abort trace buffer management event, the frozen TRBPTR_EL1 is the address that generated the fault or External abort.                                                                                                                                                                                                                             |
|           | For an asynchronous External abort trace buffer management event, the frozen TRBPTR_EL1 is not guaranteed to be the address that generated the External abort.                                                                                                                                                                                                                        |

## D6.5.1 Prioritization of a trace buffer management event

| R MKCHT   | Where multiple synchronous trace buffer management events occur on writing trace data, the PE prioritizes them from highest to lowest priority, reporting the highest priority event as follows:   |
|-----------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| I BRLXK   | Do not confuse the prioritization of trace buffer management events with the prioritization of trace buffer management interrupts by an interrupt controller.                                      |
| R GTMJD   | Asynchronous and IMPLEMENTATION DEFINED trace buffer management events are not prioritized relative to synchronous trace buffer management events.                                                 |

## D6.5.2 Buffer full and buffer wrap events

RMBSHC

RVBDJZ

RGDSTS

IVCDNP

SHKNBM

If the current write pointer is wrapped to the Base pointer and the trace buffer mode is Fill mode, then all of the following occur:

- Atrace buffer management event is generated. This sets TRBSR\_ELx.IRQ to 1.
- TRBSR\_ELx.WRAP is set to 1.
- The TRB\_WRAP event is generated.
- If TRBSR\_ELx.S is 0, then all of the following occur:
- -TRBSR\_ELx.S is set to 1, collection is stopped.
- -TRBSR\_ELx.EC is set to 0x00 , other buffer management event.
- -TRBSR\_ELx.BSC is set to 0b000001 , buffer filled.

ELx is defined by RBNQRP. See also Table D6-7. The other fields in TRBSR\_ELx and the other TRBSR\_ELx registers are unchanged.

After the trace buffer management event, the current write pointer will point to the Base pointer .

If the current write pointer is wrapped to the Base pointer and the trace buffer mode is Wrap mode, then all of the following occur:

- Atrace buffer management event is generated. This sets TRBSR\_ELx.IRQ to 1.
- TRBSR\_ELx.WRAP is set to 1.
- The TRB\_WRAP event is generated.

Because TRBSR\_ELx.S is unchanged, trace continues to be collected and written to the trace buffer.

ELx is defined by RBNQRP. See also Table D6-7. The other fields in TRBSR\_ELx and the other TRBSR\_ELx registers are unchanged.

If the current write pointer is wrapped to the Base pointer and the trace buffer mode is Circular Buffer mode, then all of the following occur:

- TRBSR\_ELx.WRAP is set to 1, where ELx is the value in the Other event column of Table D6-7. The other fields in TRBSR\_ELx and the other TRBSR\_ELx registers are unchanged.
- The TRB\_WRAP event is generated.

If collection is stopped, the when collection is stopped.

Software can configure the PMU to count the TRB\_WRAP event and monitor how many times the current write pointer has wrapped, particularly in Circular Buffer mode or Wrap mode.

IJSQPH

See also Controlling generation of trace buffer management events.

## D6.5.3 Trigger event

IHHLBM

The Trace Buffer Extension supports detection of a trigger condition from the trace unit. A trigger condition is typically used to stop trace capture to ensure trace is captured around a point of interest.

The trace unit defines how software programs the trace unit to generate trigger conditions.

A Detected Trigger is signaled to the Trace Buffer Unit by the trace unit when the trace unit detects a trigger condition. The trace unit defines whether the Detected Trigger is signaled synchronously or asynchronously to the trace data stream.

A Trigger Event occurs when the Trigger Counter has counted the specified number of trace bytes after a Detected Trigger . Software can set the Trigger Counter to zero to skip this step.

The Trigger Counter is a counter used to delay a Trigger Event for a specified number of trace bytes after a Detected Trigger .

Figure D6-2 shows this.

current write pointer is not updated, meaning the

current write pointer is never wrapped

<!-- image -->

Figure D6-2 Trigger condition to Trigger Event

| I YRQCN   | For a trace unit that implements FEAT_ETE, event 0 is the trigger condition.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
|-----------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| S DHJTB   | When the trigger mode is set to Stop on trigger , software uses the Trigger Counter to control how trace is collected around the Detected Trigger as follows: • Set the Trigger Counter to zero to trace before the Detected Trigger . • Set the Trigger Counter to half the size of the trace buffer to trace around the Detected Trigger .                                                                                                                                                                                                                                                                                                                                                                                        |
| I KLRBB   | Restrictions on programming the Trace Buffer Unit defines additional constraints on writing to the Trigger Counter .                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| R KSQJW   | If a Detected Trigger occurs while the Trace Buffer Unit is enabled, then TRBSR_ELx.TRG is set to 1, where ELx is the value in the Other event column of Table D6-7. The other fields in TRBSR_ELx and the other TRBSR_ELx registers are unchanged.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| R BQTGW   | If all of the following are true, then the Trace Buffer Unit decrements the Trigger Counter by 1 for each byte of trace data written to the trace buffer by the Trace Buffer Unit: • The Trigger Counter is nonzero.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| R QFGNQ   | If a Detected Trigger occurs when the Trigger Counter is nonzero and TRBSR_ELx.TRG is 0, the Trace Buffer Unit might decrement the Trigger Counter by an amount up to the value specified by TRBIDR_EL1.Align without writing any additional trace data to the trace buffer. ELx is the value in the Other event column of Table D6-7.                                                                                                                                                                                                                                                                                                                                                                                              |
| I QQKZF   | An implementation might include an internal buffer that collects bytes of trace data into more convenient units before writing them to memory. For example, the width of the system bus or the length of a cache line. In such an implementation, TRBIDR_EL1.Align specifies the size of this unit, and the Trigger Counter is decremented by the size of this unit when the write occurs, meaning the Trigger Counter is always aligned to the size specified by TRBIDR_EL1.Align. However, this means that if the Detected Trigger occurs when such an internal buffer is not empty, the Trace Buffer Unit will over-decrement the counter when the internal buffer is written to memory. R QFGNQ permits this. See alsoR BWNRF . |
| R DHLQG   | A Trigger Event is generated when the Trace Buffer Unit is enabled and one of the following occurs: • A Detected Trigger occurs when the Trigger Counter is zero and TRBSR_ELx.TRG is 0. ELx is defined by the value in the Other event column of Table D6-7. • The Trace Buffer Unit decrements the Trigger Counter to zero.                                                                                                                                                                                                                                                                                                                                                                                                       |
| I ZGFSK   | A Trigger Event is not generated when a Detected Trigger occurs, the Trigger Counter is set to zero. TRBSR_ELx.TRG is already 1, where ELx is the value in the Other event column of Table D6-7. A Trigger Event is not generated when the Trace Buffer Unit is disabled.                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| R RWJNN   | The Detected Trigger might be generated by a trace operation t T . This might be the trace operation generated by an instruction that also matched the trigger condition, or might be a trace operation generated asynchronously by the trace unit to mark the trigger condition in the trace data. The trace unit defines this relationship for triggers.                                                                                                                                                                                                                                                                                                                                                                          |

RMLZZW

## RXYPYF

A Trigger Event might be generated by a trace operation as follows:

- If the Trigger Event is generated when a Detected Trigger occurs when the Trigger Counter is zero and TRBSR\_ELx.TRG is 0, and the Detected Trigger is generated by a trace operation tT then the Trigger Event is generated by the same trace operation tT.
- If the Trigger Event is generated when the Trace Buffer Unit decrements the Trigger Counter to zero, then Trigger Event is generated by the trace operation that generated the trace data that caused the Trigger Counter to decrement to zero.

A Trigger Event is not generated by a specific trace operation if the Trigger Event is generated when a Detected Trigger occurs when the Trigger Counter is zero and TRBSR\_ELx.TRG is 0, and the Detected Trigger is not generated by a specific trace operation.

ELx is the value in the Other event column of Table D6-7.

- IGPHHS The link between a Trigger Event and a trace operation that generated it affects when the trace operation is Microarchitecturally-finished and the behavior of the TSB CSYNC instruction. See RJQDJD.

## INGLLQ FEAT\_TRBE supports the following trigger modes:

## Stop on trigger

## IRQ on trigger

## Ignore trigger

Trace collection is stopped and an interrupt request is generated after a Trigger Event .

An interrupt request is generated after a Trigger Event .

The Trace Buffer Unit ignores the trigger condition.

In the Stop on trigger and IRQ on trigger modes, software specifies the amount of trace that is collected after the trigger condition before the Trigger Event .

RXRRWP If a Trigger Event is generated when collection is not stopped and the trigger mode is Stop on trigger , then all of the following occur:

- The Trace Buffer Unit initiates a trace unit flush of the trace unit.
- The TRB\_TRIG event is generated.

On completion of the trace unit flush, all of the following occur:

- Atrace buffer management event is generated. This sets TRBSR\_ELx.IRQ to 1.
- If TRBSR\_ELx.S is 0, then all of the following occur:
- -TRBSR\_ELx.S is set to 1, collection is stopped.
- -TRBSR\_ELx.EC is set to 0x00 , other buffer management event.
- -TRBSR\_ELx.BSC is set to 0b000010 , Trigger Event.
- The other fields in TRBSR\_ELx are unchanged.

ELx is defined by RBNQRP. See also Table D6-7.

After the trace buffer management event, the current write pointer will point to either the first byte after the last trace byte written to the trace buffer, or, if the last trace byte written to the trace buffer was the last byte in the trace buffer, the Base pointer .

- IMCGFL The trace unit defines the behavior and completion of a trace unit flush, including which trace operations, if any, are accepted by the Trace Buffer Unit before the trace unit flush completes.

If the Detected Trigger is generated by a trace operation tT, then the trace unit flush does not complete before the Trace Buffer Unit accepts the trace data for tT.

- IVPLRF Because the Trace Buffer Unit initiates a trace unit flush before stopping this means that, before TRBSR\_ELx.S is set to 1:
- More trace might be written to the trace buffer after the Trigger Event is detected.
- This might generate another management event that sets TRBSR\_ELx.S to 1. This means that the Trigger Event is not recorded in TRBSR\_ELx.
- This might generate another management event that sets TRBSR\_ELy.S to 1, where ELy is a different Exception level to ELx. This does not prevent the Trigger Event from being recorded in TRBSR\_ELx.

If a Trigger Event is generated when collection is not stopped and the trigger mode is IRQ on trigger , then all of the following occur:

- The Trace Buffer Unit initiates a trace unit flush of the trace unit.
- The TRB\_TRIG event is generated.

On completion of the trace unit flush, all of the following occur:

- Atrace buffer management event is generated. This sets TRBSR\_ELx.IRQ to 1, where ELx is defined by RBNQRP. See also Table D6-7.
- The other fields in TRBSR\_ELx are unchanged.

Because TRBSR\_ELx.S is unchanged, trace continues to be collected and written to the trace buffer.

RLMQHK

If a Trigger Event is generated and the trigger mode is Ignore trigger , then all of the following occur:

- TRBSR\_ELx is unchanged.

- The TRB\_TRIG event is generated.

RMWWHM

If a Trigger Event is generated when collection is stopped, then all of the following occur:

- TRBSR\_ELx is unchanged.

- The TRB\_TRIG event is generated.

INZYNN

These rules mean that trace might be collected after the Trigger Event , but are included to ensure that trace for the instructions that caused the trigger condition is not discarded in common cases.

IJDWMT

The trigger mode is controlled by TRBLIMITR\_EL1.TM.

ISJWBD

See also Controlling generation of trace buffer management events.

## D6.5.4 Faults

RQKLXR

Awrite by the Trace Buffer Unit might generate one or more of the following faults:

## Alignment fault

If TRBPTR\_EL1 is misaligned, the behavior is UNPREDICTABLE and a write to the trace buffer by the Trace Buffer Unit might generate an Alignment fault. See also RMGZWR.

## Translation fault

Any access outside the virtual address or intermediate physical address space generates a Translation fault.

The translation of a virtual address or intermediate physical address to a physical address might generate Translation fault.

Writes to the trace buffer are made as privileged writes in the owning translation regime, meaning they are not affected by the TCR\_ELx.E0PDy bits for the owning translation regime.

## Address Size fault

The translation of a virtual address or intermediate physical address to a physical address, or use of an out-of-range physical address, might generate an Address Size fault.

## Permission fault

Writes to the trace buffer are made as privileged writes in the owning translation regime. If the write does not have write permission, a Permission fault is generated. The value of PSTATE.PAN is ignored. If the Trace Buffer Unit does not manage the dirty state in translation tables, then accesses ignore the Dirty Bit Modifier bit in Page and Block descriptors and as a result, might generate a Permission fault.

## Access Flag fault

If the Trace Buffer Unit does not manage the Access flag in translation tables or hardware management of the Access flag state is disabled for the owning translation regime, then any access to a Page or Block with the Access flag bit set to 0 in a descriptor will generate an Access Flag fault.

## TLBConflict fault

IMPLEMENTATION DEFINED.

## Unsupported atomic hardware update fault

If hardware update of the translation tables is not guaranteed atomic in regard to other agents that access the memory, the translation of a virtual address to a physical address might generate an Unsupported atomic hardware update fault.

RYQMQK

## External abort on translation table walk, translation table update, or Granule Protection Table (GPT) walk

The translation of a virtual address to a physical address might generate an External abort on the translation table walk, translation table update, or GPT walk, and be treated as a synchronous MMU fault. See also External aborts.

## Granule Protection Check fault (GPC fault)

Writes to the trace buffer are subject to granule protection checks and might generate GPC faults.

MMUfault means any of these faults other than an Alignment fault.

MMUfaults other than GPC faults are not generated in External mode.

RFYBCG Writes to the trace buffer by the Trace Buffer Unit never generate watchpoints.

IDTKGB Faults do not generate an actual Data Abort exception. The ESR and FAR registers are unchanged.

SGTLCY To avoid MMU faults, Arm recommends:

- Software pins the Pages or Blocks used for the trace buffer. This includes a hypervisor pinning these Pages or Blocks in the stage 2 translation.
- If the Trace Buffer Unit does not manage the Access Flag and dirty state, software marks the Pages or Blocks as accessed and dirty. Software can discover whether address translations performed by the Trace Buffer Unit manage dirty state and the Access flag from TRBIDR\_EL1.F.
- The IPA corresponding to trace buffer pointer does not have the AssuredOnly attribute when TRBLIMITR\_EL1.nVM is 1. Otherwise, any Trace Buffer Unit writes would generate a stage 2 permission fault.

RFSPBK If a write by the Trace Buffer Unit generates an Alignment fault or MMU fault, including a Granule Protection Check (GPC) fault, and TRBSR\_ELx.S is 0, then all of the following occur:

- Atrace buffer management event is generated. This sets TRBSR\_ELx.IRQ to 1.
- TRBSR\_ELx.S is set to 1, collection is stopped.
- TRBSR\_ELx.EC is set to the appropriate one of the following values:
- -0x1E , GPC fault on write to trace buffer, other than a Granule Protection Fault (GPF).
- -0x24 , stage 1 Data Abort on write to trace buffer.
- -0x25 , stage 2 Data Abort on write to trace buffer.

AGPFontranslation table walk or update is reported as either a stage 1 or stage 2 Data Abort, as appropriate. Other GPFs are reported as a stage 1 Data Abort.

- TRBSR\_ELx.FSC is set to indicate the type of the fault.
- TRBPTR\_EL1 is set to the address that generated the fault.
- The other fields in TRBSR\_ELx are unchanged.

If the MMU fault is an External abort on a translation table walk, translation table update, or GPT walk, then it is IMPLEMENTATION DEFINED whether TRBSR\_ELx.EA is set to 1 or unchanged.

The value of ELx depends on the type of event, and is defined by RBNQRP. The other fields in TRBSR\_ELx and the other TRBSR\_ELx registers are unchanged.

RLYHGV For a stage 2 MMU fault on Trace Buffer Unit writes, TRBSR\_ELx.TopLevel is set as follows:

- 1, for a stage 2 Permission fault due to the TopLevel attribute.
- 0, for any other stage 2 fault.

ELx is defined by RBNQRP. See also Table D6-7.

For a stage 2 MMU fault on Trace Buffer Unit writes, TRBSR\_ELx.AssuredOnly is set as follows:

- 1, for a stage 2 Permission fault due to the AssuredOnly attribute.
- 0, for any other stage 2 fault.

ELx is defined by RBNQRP. See also Table D6-7.

In the case of a stage 2 Data Abort on a write to trace buffer, the PE does not record whether the fault was due to a stage 2 fault on the access, or a stage 2 fault on a stage 1 translation table access.

RYCPZX

IZNPQG

## D6.5.5 External aborts

RGQWBF

When a write to the trace buffer generates an External abort, including an External abort on a translation table walk, translation table update, or GPT walk, then one of the following occurs, and it is IMPLEMENTATION DEFINED which:

- The External abort is ignored.
- The External abort generates an SError exception.
- For an External abort on a translation table walk, translation table update, or GPT walk only, the External abort generates a synchronous MMU fault.
- If Armv9.3 is not implemented, the External abort is reported to the Trace Buffer Unit and the Trace Buffer Unit generates a trace buffer management event.

## D6.5.5.1 The External abort is ignored

If the External abort is ignored, this has the same visible behavior as when a write does not generate any External abort. TRBSR\_ELx is not modified.

## D6.5.5.2 The External abort generates an SError exception

If a write to the trace buffer generates an External abort that is taken as an SError exception, the PE takes the SError exception as normal. TRBSR\_ELx is not modified.

## D6.5.5.3 The External abort generates a synchronous MMU fault

When an External abort on a translation table walk, translation table update, or GPT walk genarates a synchronous MMUfault, the behavior is as described by Faults.

## D6.5.5.4 The External abort is reported to the Trace Buffer Unit

The behavior in this section is not permitted if Armv9.3 is implemented.

When an External abort is reported to the Trace Buffer Unit, then one of the following occurs, and it is IMPLEMENTATION DEFINED which:

- The External abort is handled synchronously by the Trace Buffer Unit.
- The External abort is handled asynchronously by the Trace Buffer Unit.

When an External abort is reported to the Trace Buffer Unit:

- The External abort bit, TRBSR\_ELx.EA, is set to 1.
- The Trace Buffer Unit stops writing trace data to the trace buffer.
- If the Trace Buffer Unit handles External aborts synchronously, TRBPTR\_EL1 is set to the address that generated the External abort.

If the Trace Buffer Unit handles External aborts asynchronously, TRBPTR\_EL1 is not guaranteed to be set to the address that generated the External abort.

- If TRBSR\_ELx.S is 0, then all of the following occur:
- -Atrace buffer management event is generated. This sets TRBSR\_ELx.IRQ to 1.
- -TRBSR\_ELx.S is set to 1, collection is stopped.
- -TRBSR\_ELx.EC is set as follows:
- -If the External abort is on a GPT fetch, 0b011110 , Granule Protection Check fault on write to buffer, other than Granule Protection Fault (GPF).
- -If the External abort is on a stage 2 translation table access, 0b100101 , stage 2 Data Abort on write to buffer.
- -Otherwise, 0b100100 , stage 1 Data Abort on write to buffer.
- -TRBSR\_ELx.FSC is set to indicate the type of External abort.
- The other TRBSR\_ELx fields are unchanged.

ELx is defined by RBNQRP. See also Table D6-6. The other fields in TRBSR\_ELx and the other TRBSR\_ELx registers are unchanged.

If the Trace Buffer Unit handles External aborts asynchronously, then all of the following apply:

- The External abort trace buffer management event might not be generated until after a first trace buffer management event has set TRBSR\_ELx.S to 1.

IFBNFC

RVKWPM

ILNXGR

INHQGS

RNZTKV

RXRLSC

ITVKJR

- Writes to the trace buffer might generate a second trace buffer management event after the External abort trace buffer management event has set TRBSR\_ELx.S to 1.
- The Trace Buffer Unit might collect further trace data from the trace unit and write it to memory before the External abort trace buffer management event sets TRBSR\_ELx.S to 1.

## D6.5.6 IMPLEMENTATION DEFINED management events

RCHNSL

When IMPLEMENTATION DEFINED conditions are met all of the following occur:

- Atrace buffer management event is generated. This sets TRBSR\_ELx.IRQ to 1.
- TRBSR\_ELx.S is set to 1, collection is stopped.
- TRBSR\_ELx.EC is set to 0x1F , IMPLEMENTATION DEFINED buffer management event.
- TRBSR\_ELx.MSS is set to an IMPLEMENTATION DEFINED value.
- The other fields in TRBSR\_ELx and the other TRBSR\_ELx registers are unchanged.

ELx is defined by RBNQRP. See also Table D6-7.

ILKLHH The intent of this event is for cases such as errata workarounds to allow an implementation to report any failure to write data to the buffer that is not covered by other codes. Arm recommends that such mechanisms are disabled on reset.