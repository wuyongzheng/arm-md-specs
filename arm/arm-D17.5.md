## D17.5 Filtering sample records

After the sampled operation has finished execution,the Statistical Profiling Unit might discard the sample records generated by the profiling operation.

PMSFCR\_EL1 controls filtering of sample records, as described in the following sections. If multiple filters are enabled, a packet is discarded if it is discarded by any of the enabled filters. These controls combine together as a logical AND.

Example D17-1 Collection of sampled operations

If PMSFCR\_EL1.FE is 1, PMSFCR\_EL1.FnE is 0, PMSFCR\_EL1.FT is 1, and PMSFCR\_EL1.FL is 1, then only sampled operations that meet all of the following criteria are recorded and written to the Profiling Buffer:

- The sampled operation is one of the selected operation types.
- The operation has all of the events in the filter set.
- The total latency is equal to or greater than the minimum latency.

This is described in the pseudocode function SPECollectRecord() .

## D17.5.1 Filtering by operation type

- IBWNKX

PMSFCR\_EL1.FT enables filtering by operation type. When enabled PMSFCR\_EL1.{ST, LD, B, FP, SIMD, STm, LDm, Bm, FPm, SIMDm} define the collected types.

- IZZTZL

RNYZKJ

## DDSNMB

When FEAT\_SPE\_EFT is implemented, the following values are defined:

- PMSFCR\_EL1.{SIMD, FP, ST, LD, B} are the operation type filter controls, ctrl .
- PMSFCR\_EL1.{SIMDm, FPm, STm, LDm, Bm} are the operation type filter mask, mask .
- flags is a five bit value {SIMD, FP, B, LD, ST} that defines the type of the sampled operation.

When FEAT\_SPE\_EFT is not implemented:

- PMSFCR\_EL1.{ST, LD, B} are the operation type filter controls, ctrl .
- The operation type filter mask, mask , is zero.
- flags is a three bit value {ST, LD, B} that defines the type of the sampled operation.

Filtering by SIMD&amp;FP types is not supported.

The operation types are defined as follows:

- ST Means a sampled store operation, including all atomic operations. That is, an operation counted by ST\_SPEC.
- LD Means a sampled load operation, including atomic operations that return a value to a register. That is, an operation counted by LD\_SPEC.
- B Means a sampled branch operation, including direct and indirect branches and exception returns. That is, an operation counted by PC\_WRITE\_SPEC, including branches which are not taken, but excluding BRK , SVC , HVC , SMC , and UNDEFINED instructions which generate exceptions. It is IMPLEMENTATION DEFINED whether ISB is sampled as a branch operation.
- FP Means a sampled floating-point operations including all of the following:
- Floating-point data-processing operations, including scalar, Advanced SIMD, SVE, and SME floating-point data-processing operations. That is, operations counted by FP\_SPEC.
- Scalar load/store of a SIMD&amp;FP register or pair of SIMD&amp;FP registers, excluding loads/stores of Q registers, load and replicate, and structure loads/stores.

Only supported when FEAT\_SPE\_EFT is implemented.

Means a sampled SIMD operation, including all of the following:

- Advanced SIMD, SVE, or SME SIMD data-processing operations.
- Structure load/store of one or more SIMD&amp;FP registers.

SIMD

IZWMZT

RYGCFK

ILVCZH

IXNXRN

- Load and replicate to one or more SIMD&amp;FP registers.
- Scalar load/store of a SIMD&amp;FP Q register or pair of Q registers.
- SVE or SME load/store.

That is, an operation counted by SIMD\_INST\_SPEC.

Only supported when FEAT\_SPE\_EFT is implemented.

An operation might be more than one type, in which case the flags field has all applicable bits set. For example:

- Ascalar load of a single SIMD&amp;FP register has both the FP and LD bits set.
- An Atomic operation that returns a value to the PE has both the LD and ST bits set.

When FEAT\_SPE\_EFT is implemented and PMSFCR\_EL1.FT is 1, all of the following apply:

- The sampled operation is discarded if the following is true:

(!IsZero(ctrl AND NOT mask) &amp;&amp; IsZero(flags AND (ctrl AND NOT mask)))

That is, the SPU applies a Boolean-OR filter based on each of the operation type filter controls where the corresponding operation type filter mask bit is 0:

- -If all the operation type filter mask bits are 1, then no operations are discarded by this part of the filter.
- -Otherwise, for the operation type bits for which corresponding mask bit is 0:
- -If all these bits are 0, then no operations are discarded by this part of the filter.
- -Otherwise, operations that match any of these bits are selected, and other operations are discarded.
- The sampled operation is discarded if the following is true:

(flags AND mask) != (ctrl AND mask)

That is, the SPU applies a Boolean-AND filter based on the remaining operation type filter controls where the corresponding operation type filter mask bit is 1:

- -If all the operation type filter mask bits are 0, no operations are discarded by this part of the filter.
- -Otherwise, only operations that exactly match all of these bits are selected, and other operations are discarded.

When FEAT\_SPE\_EFT is not implemented and PMSFCR\_EL1.FT is 1, all of the following apply:

- If operation type filter controls, ctrl , is zero, it is CONSTRAINED UNPREDICTABLE whether an operation is collected or discarded.
- Otherwise, the sampled operation is discarded if the following is true:

IsZero(flags AND ctrl)

That is, only operations that match any of the types selected in the operations type filter controls are selected, and other operation types are discarded.

When micro-op sampling is implemented, filtering is based on the micro-op type. See Defining the sample population.

## D17.5.2 Filtering by the contents of the Events packet

PMSFCR\_EL1.FE enables filtering by events, Streaming mode, and Transactional mode bits that are defined by PMSEVFR\_EL1. When PMSFCR\_EL1.FE is 1, only sampled operations with all the events in the filter set to 1 are recorded and written to the Profiling Buffer.

If FEAT\_SPE\_FnE is implemented, PMSFCR\_EL1.FnE enables filtering by events, Streaming mode, and Transactional mode bits that are defined by PMSNEVFR\_EL1. When PMSFCR\_EL1.FnE is 1, only sampled operations with all the events in the filter set to 0 are recorded and written to the Profiling Buffer.

## D17.5.3 Filtering by latency

PMSFCR\_EL1.FL enables filtering by total latency. PMSLATFR\_EL1.MINLAT defines the minimum latency. When PMSFCR\_EL1.FL is 1, only sampled operations with a total latency greater than or equal to the minimum latency are recorded and written to the Profiling Buffer.

## D17.5.4 Filtering by data source

If FEAT\_SPE\_FDS is implemented, PMSFCR\_EL1.FDS enables filtering by a data source mask defined by PMSDSFR\_EL1. When PMSFCR\_EL1.FDS is 1, sampled load operations with a Data Source packet value DS are recorded only if PMSDSFR\_EL1[UInt(DS[5:0])] is 1. Load operations without a Data Source and other sampled operations are not affected by PMSFCR\_EL1.FDS and PMSDSFR\_EL1.

## D17.5.5 Discard mode

When Discard mode is implemented and enabled, all sampled operations to be discarded and not written to the Profiling Buffer. Discard mode is enabled when PMBLIMITR\_EL1.FM is 0b10 , and has all of the following effects:

- All profiling data is discarded after filtering.
- The PMBLIMITR\_EL1.LIMIT and PMBPTR\_EL1 fields are ignored. PMBPTR\_EL1 does not increment for each sampled operation.
- The restrictions on setting PMBLIMITR\_EL1.LIMIT and PMBPTR\_EL1 do not apply, see Restrictions on the current write pointer.
- Buffer management events are not generated.

Discard mode is implemented when FEAT\_SPEv1p2 is implemented.

Other profiling behaviors are unchanged, including:

- The discarding of profiling data occurs after SAMPLE\_FILTRATE and other PMU events are counted.
- Sample collisions will still set PMBSR\_ELx.COLL to 1. See Sample collisions.