## D6.6 Synchronization and the Trace Buffer Unit

| I NMWZY   | Program Flow Trace data is generated by traced instructions. When an instruction is executed: 1. The PE decides whether to create a trace operation for the instruction. 2. If created, the trace operation generates the Program Flow Trace data.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
|-----------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| R ZVDST   | Trace operations operate independently of the instructions that are executed on the PE and make indirect reads and indirect writes of System registers as an external agent .                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| I TPVQR   | The synchronization requirements for direct reads, direct writes, indirect reads, and indirect writes of System registers made by instructions and external agents are defined in Synchronization requirements for AArch64 System registers.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| R NRLDV   | Synchronization in self-hosted trace defines that indirect reads of the TRFCR_EL1.{E1TRE, E0TRE} and TRFCR_EL2.{E2TRE, E0HTRE} trace filter controls when determining whether the current Execution stream is part of a prohibited trace region and an instruction Ashould generate a trace operation, are treated as indirect reads made by A.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| R SXXQJ   | Each System register access made by the trace unit is one of the following, and the trace unit defines which: • An indirect read or indirect write rw A made by an instruction A. For example, to determine whether to generate a trace operation for A. • An indirect read or indirect write rw tA made by a trace operation t A . This is in addition to System register accesses defined by this manual as indirect reads or indirect writes made by the Trace Buffer Unit.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| I DDLVC   | In addition to the registers listed byR NRLDV , for the ETE, the following ETE System registers are indirectly read by an instruction Ato determine whether Ashould generate a trace operation: • TRCPRGCTLR.EN, the Trace unit enable bit in the Programming Control Register. • TRCOSLSR.OSLK, the Trace OS Lock Status Register. This manual defines which System registers are indirectly read or indirectly written by the Trace Buffer Unit as part of the trace operation t A for a traced instruction A. For example: • Trace Buffer Unit System registers. • VMSASystem registers and SCR_EL3.NS, when translating addresses generated by the Trace Buffer Unit. Other System registers are indirectly read or indirectly written by the trace unit as part of the trace operation t A for a traced instruction A. For example: • Other ETE System registers. • If context tracing is enabled, the applicable Context ID register or registers, CONTEXTIDR_EL1 or CONTEXTIDR_EL2. • If trace timestamping is enabled, any applicable counter offset, CNTVOFF_EL2 or CNTPOFF_EL2. Some ETE System registers are indirectly read or indirectly written by, for example, the ETE Resources when generating trace operations or updating the ETE Resources, and are made by neither a trace operation of an instruction nor an instruction. The behavior of the ETE is defined by FEAT_ETE. See also Trace synchronization and the Trace Unit. |
| GVCVL     | The indirect reads and indirect writes to Trace Buffer Unit, VMSAand other System registers made by the Trace Buffer Unit are made by the trace operation t OP .                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| I         |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| I BYSGH   | To synchronize trace operations, software must use the TSB CSYNC instruction to generate a Trace Synchronization event.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |

RGTCKK

RNNLMC

In the absence of any explicit synchronization, the trace unit generates the trace data for an instruction and the Trace Buffer Unit accepts , discards , or rejects the trace data in finite time. However:

- If the Trace Buffer Unit accepts the trace data, then the write of the trace data to memory requires explicit synchronization to Complete.
- The indirect writes to System registers made by a trace operation require explicit synchronization to guarantee they are observable.

If FEAT\_TRBE\_EXT is implemented and TRBSR\_EL1.DAT is 0, then all Trace operations Accepted by the Trace Buffer Unit will Complete in finite time.

## D6.6.1 Trace Synchronization event

RVWJNN

Executing a TSB CSYNC instruction generates a Trace Synchronization event.

RJQDJD

RNSFRQ

RMRVPT

RZCDDS

Atrace operation tOP is not Microarchitecturally-finished before all of the following are true:

- All indirect reads and indirect writes of System registers made by tOP have been performed.
- If tOP generates a Trigger Event that in turn initiates a trace unit flush , then all of the following are true:
- -The trace unit flush is complete.
- -All trace operations the Trace Buffer Unit accepts before the trace unit flush completes are Microarchitecturally-finished.
- -All indirect writes to System registers made by the Trace Buffer Unit on completion of the trace unit flush have been performed.

Indirect reads and writes include but are not limited to the following:

- All indirect reads and indirect writes of the Trace Buffer Unit, VMSA System registers, and SCR\_EL3.{NSE, NS} made by memory accesses performed by tOP.
- All indirect writes to System registers made by a trace buffer management event generated by tOP.

However, this does explicitly exclude any indirect writes of System registers made in response to an External abort by the access.

Atrace operation tOP

is complete when it is Microarchitecturally-finished and all memory accesses performed by tOP

are

Complete and any indirect writes of System registers made in response to an External abort response to the access have been performed.

If, following a Context synchronization event CSE the PE is executing in a Trace Prohibited region, a TSB CSYNC executed in the Trace Prohibited region and Non-debug state in program order after CSE is not Microarchitecturally-finished before all of the following are true:

- All trace operations tA generated by instructions A in program order before CSE are Microarchitecturally-finished.
- All trace operations tS generated by Speculative instructions S that are not in speculative execution order after CSE are Microarchitecturally-finished.
- All trace operations tR generated by the trace unit are Microarchitecturally-finished.
- The trace unit enters a state where the trace unit does not generate further trace operations and does not signal a Detected Trigger . The trace unit remains in this state while the PE is executing in the Trace Prohibited region.
- If a trace unit flush is initiated by a Trigger Event before the TSB CSYNC is Microarchitecturally-finished, the trace unit flush is complete, all trace operations the Trace Buffer Unit accepts before the trace unit flush completes are Microarchitecturally-finished, and any indirect writes made by the Trace Buffer Unit on completion of the trace unit flush have been performed.

These trace operations are synchronized by the TSB CSYNC .

Adirect write W2 to a System register made by an instruction B is Coherence-after an indirect read or indirect write rw1 of the same System register made by a trace operation tA for a traced instruction A if all of the following are true:

- Either A is executed in program order before a Context synchronization event CSE, or A is CSE.
- CSE is in program order before a Trace synchronization barrier TSB.
- Bis executed in program order after TSB.
- After executing CSE, the PE is in a Trace Prohibited region and TSB is executed in Non-debug state in the same Trace Prohibited region.

IFZHQG

RZCDDS emerges from the requirement in RMRVPT for the trace operations to be Microarchitecturally-finished by the TSB CSYNC operation.

Self-hosted trace extension synchronization rules and Trace in Debug state define further rules for the operation of TSB CSYNC .

IZKRZH

The PE does not stall indefinitely (or until interrupted) waiting for a TSB CSYNC . For example, the TSB CSYNC must not wait until there is no trace data left to write if the trace unit is capable of producing a constant stream of trace data.

IZLDPS

APEmight abandon a TSB CSYNC executed in Non-debug state before it is Microarchitecturally-finished to take an interrupt, so long as the preferred return address is set such that the TSB CSYNC is re-executed when the interrupt handler completes. That is, the TSB CSYNC is only Speculatively executed.

RCKVWP

Absent any Context synchronization event or DSB Data synchronization barrier, a TSB CSYNC instruction is not required to execute in program order with respect to other instructions or memory accesses. This means that software must execute additional barriers to guarantee that the trace operations are Microarchitecturally-finished and/or complete.

## D6.6.2 Trace synchronization and the Trace Unit

| I ZYZGZ   | The ETE has Resources that can generate trace operations that are not directly generated by an instruction or Speculative instruction. The ETE specification defines the following rules: • The Resources do not generate trace operations in the Paused state. • If, following a Context synchronization event, the PE is executing in a Trace Prohibited region and the ETE is enabled, the ETE pauses the ETE Resources. • How software synchronizes indirect writes to System registers made by trace operations generated by Resources.   |
|-----------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| I GFJWK   | If FEAT_RME is implemented, further rules are defined for the behavior of the trace unit when a TSB CSYNC instruction is executed.                                                                                                                                                                                                                                                                                                                                                                                                             |
| R QVGHP   | Atrace operation t R generated by ETE Resources inherits the synchronization requirements for a trace operation generated by an instruction A, even if no trace operation is generated by A, provided that one of the following applies: • The requirement is that Ais executed in program-order after CSE and tracing was prohibited before CSE and is allowed after CSE.                                                                                                                                                                     |
| R YWSDB   | If the trace unit becomes enabled when the PE is executing a Trace Prohibited region, it does not generate any trace operations, including trace operations for Speculative instructions and other trace operations not generated by instructions, until the PE enters a region where tracing is allowed.                                                                                                                                                                                                                                      |
| I XGQRM   | The trace unit defines the sequence by which software enables the trace unit.                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |

## D6.6.3 Self-hosted trace extension synchronization rules

ICMGRF

FEAT\_TRF defines further rules for the TSB CSYNC instruction. In particular, how a TSB CSYNC instruction synchronizes direct reads and indirect writes to a System register with respect to indirect reads and indirect writes of the same System register made by trace operations.

These rules restate the synchronization behavior described in Memory barriers and Synchronization in self-hosted trace. RTSPXF is similar to RZCDDS and RXQVZW. However:

- RTSPXF applies whether the TSB CSYNC operation is executed in a trace prohibited or trace allowed region, in both Non-debug state and Debug state. RZCDDS applies only when the TSB CSYNC is executed in a Trace Prohibited region and the PE is in Non-debug state, and RXQVZW applies only when the TSB CSYNC is executed when the trace unit is disabled and the PE is in Debug state.
- RTSPXF applies only to System registers accessed by the trace unit as part of a trace operation. RZCDDS and RXQVZW apply to all System register accesses made by the trace operation and includes indirect reads and indirect writes made by the Trace Buffer Unit.

See RSXXQJ and IDDLVC.

| R BFJKD   | An indirect read r 1 of a System register made by a trace operation t A for a traced instruction AReads-from a direct write W 2 to the same System register made by an instruction Bif all of the following are true: • Ais executed in program order after a Context synchronization event CSE. • Bis executed in program order before CSE.                                                                                                                                                                                                                                    |
|-----------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| S YPWVJ   | R BFJKD means that, if the PE enters a region where tracing is allowed by executing a Context synchronization event, such as an ERET instruction when SCTLR_ELx.EOS is 1, then all indirect reads and writes of System registers made by trace operations generated after entering the tracing allowed region will observe the values in those System registers written by direct writes before the Context synchronization event.                                                                                                                                              |
| R MJQXM   | An indirect writew 1 of a System register made by a trace operation t A for a traced instruction Ais Coherence-after a direct writeW 2 of the same System register made by an instruction Bif all of the following are true: • Ais executed in program order after a Context synchronization event CSE. • Bis executed in program order before CSE.                                                                                                                                                                                                                             |
| R TSPXF   | Adirect writeW 2 to a System register made by an instruction Bis Coherence-after an indirect read or indirect write rw 1 of the same System register made by the trace unit as part of a trace operation t A for a traced instruction Aif all of the following are true: • Either Ais executed in program order before a Context synchronization event CSE, or Ais CSE. • CSE is in program order before a Trace synchronization barrier TSB.                                                                                                                                   |
| R VTNCS   | Adirect readR 2 of a System register made by an instruction BReads-from an indirect writew 1 to the same System register made by a trace operation t A for a traced instruction Aif all of the following are true: • Either Ais executed in program order before a first Context synchronization event CSE 1 , or Ais CSE 1 . • CSE 1 is in program order before a Trace synchronization barrier TSB.                                                                                                                                                                           |
| R NNRHD   | An instruction Ain program-order after a direct write Wthat modifies one of the trace filter controls, TRFCR_EL1.{E1TRE, E0TRE} and TRFCR_EL2.{E2TRE, E0HTRE}, Reads-from Wwhendetermining whetherA should generate a trace operation, if there is no intervening direct write to the same register and any of the following is true: • Ais in program-order after a Context synchronization event CSE and CSE is in program-order after W. • An instruction BReads-from Wwhendetermining whether Bshould generate a trace operation, and Ais in                                |
| I VKRGM   | R NNRHD means that for the instructions between a direct write to one of the trace filter controls to either enable or disable trace at the current Exception level and a following Context synchronization event, although it is UNPREDICTABLE whether each instruction observes the old or new values of the trace filter controls, once one instruction has observed the new value, all subsequent instructions also observe the new value. However this might not happen, and all instructions might observe the old values until the Context synchronization event occurs. |