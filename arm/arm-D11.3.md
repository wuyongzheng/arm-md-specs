## D11.3 Procedure returns

- GBSBZN FEAT\_GCS provides means to protect procedure return addresses.
- GQLGCM FEAT\_GCS provides means to record call stacks.

RMSYQB Aprocedure return address push operation performs the following:

1. Stores a doubleword to the virtual address defined by the current Guarded Control Stack pointer register minus the size of a Guarded Control Stack procedure return record.
2. Decrements the current Guarded Control Stack pointer register by the size of a Guarded Control Stack procedure return record.

RLWRMC Aprocedure return address pop and compare operation performs the following:

1. Loads a doubleword from the virtual address defined by the current Guarded Control Stack pointer register.
2. The value in the record is compared with the value in the branch target register:
- If the values are the same, increments the current Guarded Control Stack pointer register by the size of a Guarded Control Stack procedure return record.
- If the values are not the same, a GCS Data Check exception is generated.
5. RBMMYF Aprocedure return address pop operation performs the following:
1. Loads a doubleword from the virtual address defined by the current Guarded Control Stack pointer register.
2. Increments the current Guarded Control Stack pointer register by the size of a Guarded Control Stack procedure return record.
8. RQHNWF The Guarded Control Stack at ELx has Return value checking enabled if GCSCR\_ELx.RVCHKEN is 1. x is any of 1, 2, 3.

The Guarded Control Stack at EL0 has Return value checking enabled if GCSCRE0\_EL1.RVCHKEN is 1.

- RZNPXD The Guarded Control Stack at ELx has Return value checking disabled at ELx if the Guarded Control Stack at ELx does not have Return value checking enabled.
- INLMNQ If the Guarded Control Stack at ELx has Return value checking disabled, this means the address present in the target register of a procedure return instruction is ignored and the top entry on the Guarded Control Stack is popped and used as the target address.

For example, for a RET instruction that uses the LR as the intended target address register, the value in LR is ignored.

- IGNXCT Irrespective of whether address tagging for instruction addresses is enabled or not, all 64 bits are compared in the compare operation of the procedure return address pop and compare operation.
- IXFKQN Guarded Control Stacks are defined as full-descending stacks and there are no controls provided to operate the Guarded Control Stacks as empty-descending stacks or ascending stacks.
- DVKRDG Each Memory Write effect and Memory Read effect generated by the following instructions is referred to as a Guarded Control Stack data access:
- Branch with link instructions.
- Procedure return instructions.
- GCSPOPM .
- GCSSS1 .
- GCSSS2 .
- GCSPUSHM .
- GCSPUSHX .
- GCSPOPX .
- GCSPOPCX .
- GCSSTR .
- GCSSTTR .

## D11.3.1 Procedure call and return instructions

- GPYLXG FEAT\_GCS provides means to protect procedure return addresses without recompilation of functions or increasing the code footprint of functions.

RMXSDP

On executing any branch with link instruction, before branching to the target address, if the Guarded Control Stack is PCR Enabled at the current Exception level then a procedure return address push operation is generated. The data value for the store operation of the procedure return address push operation is the value of LR which is created by the branch with link instruction.

RMMFFJ

RQBJCD

RMRQPD

The branch with link instructions are defined as:

- BL .
- BLR .
- BLRAA, BLRAAZ, BLRAB, BLRABZ .

On executing a procedure return instruction, before branching to the target address, if the Guarded Control Stack at the current Exception level is PCR Enabled, one of the following operation is generated:

- If the Guarded Control Stack at the current Exception level has Return value checking enabled, then a procedure return address pop and compare operation is generated. The procedure return address pop and compare operation has a lower priority than any authentication operation performed by the same instruction.
- If the Guarded Control Stack at the current Exception level has Return value checking disabled, then a procedure return address pop operation is generated. The procedure return address pop operation has lower priority than any authentication operation performed by the same instruction. The popped value is used as the target address for branching to the next instruction.

The procedure return instructions are defined as:

- RET .
- RETAA, RETAB .
- RETAASPPC, RETABSPPC .
- RETAASPPCR, RETABSPPCR .

## D11.3.2 Management of procedure return records

| G TSLPS   | FEAT_GCS provides means for software to add a Guarded Control Stack procedure return record to a Guarded Control Stack.                                                                                                                                                                                                                                                                                                                                                              |
|-----------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| I MLRYX   | The GCSPUSHM instruction is provided to enable software to add a doubleword in the Guarded Control Stack.                                                                                                                                                                                                                                                                                                                                                                            |
| I PYRNS   | The GCSSTR and the GCSSTTR instructions are provided to enable software to modify a doubleword in the Guarded Control Stack.                                                                                                                                                                                                                                                                                                                                                         |
| I ZBPNC   | The GCSPUSHM instruction does not sign extend the value that is being stored. This is to maintain consistency with the GCSSTR instruction behavior.                                                                                                                                                                                                                                                                                                                                  |
| I PPGKD   | The GCSPOPM instruction is provided to adjust the current Guarded Control Stack pointer register. This instruction can used in places where there is no return from subroutine instruction executed for a preceding branch with link instruction.                                                                                                                                                                                                                                    |
| R QHJBM   | While the Guarded Control Stack is GCS Enabled at the current Exception level, the GCSPOPM instruction performs the following operations: 1. Load a doubleword from the address pointed by the current Guarded Control Stack pointer register. 2. Check the [1:0] bits of the loaded value: • If the value does not equal 0b00 , a GCS Data Check exception is taken. • If the value equals 0b00 , the loaded value is written to the Xn register defined by GCSPOPM and the current |
| R SXVRB   | When the Guarded Control Stack is GCS Disabled at the current Exception level, the GCSPOPM instruction does not perform the load operation or the update to current Guarded Control Stack pointer register and executes as a NOP .                                                                                                                                                                                                                                                   |

IQLKKL

Arm strongly recommends software uses guard pages between Guarded Control Stacks to help detecting the following:

- Malicious attacks that use GCSPOPM instruction to subvert the GCSPR\_ELx value to an attacker defined value.
- An underflow or an overflow of the Guarded Control Stack for any other reasons.