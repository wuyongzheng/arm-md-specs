## D17.8 Profiling Buffer management

RFJDLW

IQRJYF

RNXZXG

RWVKFM

RTHGCR

IQRKCL

IVJVKZ

RHJXHT

AProfiling Buffer management event occurs:

- On a fault, see Faults and watchpoints.
- On an External abort, see External aborts.
- When the Profiling Buffer fills, see Buffer full event.
- When the access is not allowed for other reasons, see Access not allowed.
- For IMPLEMENTATION DEFINED reasons, see Implementation defined reason.

The Profiling Buffer management event behavior differs from that of the FEAT\_TRBE trace buffer management event.

On a Profiling Buffer management event:

- The service bit, PMBSR\_ELx.S, is set to 1.
- The data loss bit, PMBSR\_ELx.DL, is set as described in the event description.
- Additional syndrome for the event is written to PMBSR\_ELx.MSS.

The value of ELx depends on the type of event, and is defined by RHJXHT. Unless otherwise stated in the event description, other fields in PMBSR\_ELx and the other PMBSR\_ELx registers are unchanged.

The following Profiling Buffer management events are reported synchronously:

- Buffer full events.
- If FEAT\_SPEv1p5 is not implemented, Alignment fault and MMU fault events.

If FEAT\_SPEv1p3 is not implemented, it is IMPLEMENTATION DEFINED whether External aborts are reported to the Statistical Profiling Unit synchronously or asynchronously.

Reported synchronously means that profiling is disabled before the Statistical Profiling Unit samples further operations. The interrupt or Profiling exception resulting from recording the Profiling Buffer management event is an asynchronous exception.

When FEAT\_SPEv1p5 is implemented, the Statistical Profiling Unit is permitted to sample further operations after the sampled operation that generates the Alignment fault or MMU fault Profiling Buffer management event. This means that one or more samples might be discarded because of the Alignment fault or MMU fault Profiling Buffer management event.

The SPU never writes past the PMBLIMITR\_EL1 limit pointer.

Software cannot assume that:

- The PE has not modified memory between the current PMBPTR\_EL1 write pointer and the PMBLIMITR\_EL1 limit pointer minus one.
- The data between the current PMBPTR\_EL1 write pointer and the PMBLIMITR\_EL1 limit pointer minus one is valid.
- If PMBSR\_ELx.DL is set to 1 on a Profiling Buffer management event, that there is any valid data between the end of the last complete sample record and the current PMBPTR\_EL1 write pointer. The value of ELx depends on the type of event. See RHJXHT.
- Any valid data has been written to the Profiling Buffer if an External abort is reported asynchronously to the SPU. For more information, see The External abort generates a MMU fault.

The Statistical Profiling Unit generates PMU events and CTI trigger events when a sampled operation completes. If writing records to the Profiling Buffer generates an MMU fault, one or more of these events might have been generated for one or more sampled operations that are discarded because of the MMU fault.

If FEAT\_SPE\_EXC is implemented, then when a Profiling Buffer management event is generated:

- If EL3 is implemented and any of the following are true, then the management event is recorded in PMBSR\_EL3:
- -MDCR\_EL3.PMSEE is 0b11 .
- -MDCR\_EL3.PMSEE is 0b10 and the management event is due to a fault on a write to the Profiling Buffer that would generate a Data Abort exception taken to EL3 if generated by a store instruction executed at the owning Exception level. That is, any of the following faults on a write to the Profiling Buffer:
- -Granule Protection Check (GPC) faults, other than Granule Protection Faults (GPFs). For more information, see Granule Protection Check faults.

## IFDVRZ

## IJVQRY

- -If SCR\_EL3.GPF is 1, GPFs.
- -If SCR\_EL3.EA is 1, External aborts. See also IFDVRZ.
- Otherwise, if all of the following are true, then the management event is recorded in PMBSR\_EL2:
- -EL3 is not implemented or MDCR\_EL3.PMSEE is not 0b00 .
- -EL2 is implemented and any of the following are true:
- -The Effective value of SCR\_EL3.NS is 1.
- -The Effective value of SCR\_EL3.{NS, EEL2} is {0, 1}.

This applies even when the current Exception level is EL3.

- -One of the following is true:
- -PMSCR\_EL2.EE is 0b11 .
- -PMSCR\_EL2.EE is 0b10 and the management event is due to any fault on a write to the Profiling Buffer that would generate a Data Abort exception taken to EL2 if generated by a store instruction executed at the owning Exception level.

If the owning Exception level is EL2, this means any fault on a write to the Profiling Buffer. If the owning Exception level is EL1, this means any of the following faults on a write to the Profiling Buffer:

- ꞏ Stage 2 faults.
- ꞏ If HCR\_EL2.GPF is 1, GPFs.
- ꞏ If HCR\_EL2.TEA is 1, External aborts. See IFDVRZ.
- -PMSCR\_EL2.EE is 0b10 and the management event is due to a GPC fault other than a GPF.
- Otherwise, the management event is recorded in PMBSR\_EL1.

If FEAT\_SPE\_EXC is not implemented, then the management event is recorded in PMBSR\_EL1. The pseudocode function ReportSPEEvent() shows this.

When FEAT\_SPEv1p3 is implemented, External aborts are not reported on writes to the trace buffer. However, External aborts on translation table walks, translation table updates, and GPT walks can be reported as MMU faults. See Faults and watchpoints.

Table D17-5, Table D17-6, and Table D17-7 show which PMBSR\_ELx register used to record the syndrome for each type of Profiling Buffer management event.

Each column in the left side of the tables refers to the Effective value of a field in a System register.

Each column in the right side of the tables represents a Profiling Buffer management event:

## Other event

## Stage 1 (GPF)

Means a Profiling Buffer management event for a Granule Protection Fault (GPF) reported as a stage 1 abort on a write to the buffer, recorded with the EC value of 0b100100 and an FSC value indicating a GPF.

## Stage 1 (External abort)

Means a Profiling Buffer management event for an External abort reported as a stage 1 abort on a write to the buffer, recorded with the EC value of 0b100100 and an FSC value indicating an External abort.

## Stage 1 (Other abort)

Means a Profiling Buffer management event for any other stage 1 abort on a write to the buffer, recorded with the EC value 0b100100 .

## Stage 2 (GPF)

Means a Profiling Buffer management event for a GPF reported as a stage 2 abort on a write to the buffer, recorded with the EC value of 0b100101 and an FSC value indicating a GPF.

## Stage 2 (External abort)

Means a Profiling Buffer management event for an External abort reported as a stage 2 abort on a write to the buffer, recorded with the EC value of 0b100101 and an FSC value indicating an External abort. That is, a synchronous External abort on a stage 2 translation table walk or translation table update.

## Stage 2 (Other abort)

Means a Profiling Buffer management event for any other stage 2 abort on a write to the buffer, recorded with the EC value 0b100101 .

## GPCfault

Means a Profiling Buffer management event recorded with the EC value 0b000000 .

Means a Profiling Buffer management event for a Granule Protection Check fault, other than a GPF, on a write to the buffer, recorded with the EC value 0b011110 .

The values in these cells denotes which PMBSR\_ELx register is updated for that combination of control register values and Profiling Buffer management event type.

Table D17-5 SPE Profiling Buffer management event reporting (Granule Protection Checks)

| MDCR_EL3.PMSEE   | SCR_EL3.GPF   | PMSCR_EL2.EE   | MDCR_EL2.E2PB   | HCR_EL2.GPF   | GPF Stage 1   | Stage 2   | GPC fault   |
|------------------|---------------|----------------|-----------------|---------------|---------------|-----------|-------------|
| 0b00             | X             | XX             | XX              | X             | EL1           | EL1       | EL1         |
| 0b01             | X             | 0b0X           | XX              | X             | EL1           | EL1       | EL1         |
| 0b01             | X             | 0b10           | 0b00            | X             | EL2           | EL2       | EL2         |
| 0b01             | X             | 0b10           | 0b1X            | 0b0           | EL1           | EL2       | EL2         |
| 0b01             | X             | 0b10           | 0b1X            | 0b1           | EL2           | EL2       | EL2         |
| 0b01             | X             | 0b11           | XX              | X             | EL2           | EL2       | EL2         |
| 0b10             | 0b0           | 0b0X           | XX              | X             | EL1           | EL1       | EL3         |
| 0b10             | 0b0           | 0b10           | 0b00            | X             | EL2           | EL2       | EL3         |
| 0b10             | 0b0           | 0b10           | 0b1X            | 0b0           | EL1           | EL2       | EL3         |
| 0b10             | 0b0           | 0b10           | 0b1X            | 0b1           | EL2           | EL2       | EL3         |
| 0b10             | 0b0           | 0b11           | XX              | X             | EL2           | EL2       | EL3         |
| 0b10             | 0b1           | XX             | XX              | X             | EL3           | EL3       | EL3         |
| 0b11             | X             | XX             | XX              | X             | EL3           | EL3       | EL3         |

## Table D17-6 SPE Profiling Buffer management event reporting (External aborts)

| MDCR_EL3.PMSEE   | SCR_EL3.EA   | PMSCR_EL2.EE   | MDCR_EL2.E2PB   | HCR_EL2.TEA   | External abort   | External abort   |
|------------------|--------------|----------------|-----------------|---------------|------------------|------------------|
|                  |              |                |                 |               | Stage 1          | Stage 2          |
| 0b00             | X            | XX             | XX              | X             | EL1              | EL1              |
| 0b01             | X            | 0b0X           | XX              | X             | EL1              | EL1              |
| 0b01             | X            | 0b10           | 0b00            | X             | EL2              | EL2              |
| 0b01             | X            | 0b10           | 0b1X            | 0b0           | EL1              | EL2              |
| 0b01             | X            | 0b10           | 0b1X            | 0b1           | EL2              | EL2              |
| 0b01             | X            | 0b11           | XX              | X             | EL2              | EL2              |
| 0b10             | 0b0          | 0b0X           | XX              | X             | EL1              | EL1              |
| 0b10             | 0b0          | 0b10           | 0b00            | X             | EL2              | EL2              |
| 0b10             | 0b0          | 0b10           | 0b1X            | 0b0           | EL1              | EL2              |
| 0b10             | 0b0          | 0b10           | 0b1X            | 0b1           | EL2              | EL2              |
| 0b10             | 0b0          | 0b11           | XX              | X             | EL2              | EL2              |
| 0b10             | 0b1          | XX             | XX              | X             | EL3              | EL3              |
| 0b11             | X            | XX             | XX              | X             | EL3              | EL3              |

Table D17-7 SPE Profiling Buffer management event reporting (All other management events)

| MDCR_EL3.PMSEE   | PMSCR_EL2.EE   | MDCR_EL2.E2PB   | Other abort   | Other abort   | Other event   |
|------------------|----------------|-----------------|---------------|---------------|---------------|
| MDCR_EL3.PMSEE   | PMSCR_EL2.EE   | MDCR_EL2.E2PB   | Stage 1       | Stage 2       | Other event   |
| 0b00             | XX             | XX              | EL1           | EL1           | EL1           |
| 0b01             | 0b0X           | XX              | EL1           | EL1           | EL1           |
| 0b01             | 0b10           | 0b00            | EL2           | EL2           | EL1           |
| 0b01             | 0b10           | 0b1X            | EL1           | EL2           | EL1           |
| 0b01             | 0b11           | XX              | EL2           | EL2           | EL2           |
| 0b10             | 0b0X           | XX              | EL1           | EL1           | EL1           |
| 0b10             | 0b10           | 0b00            | EL2           | EL2           | EL1           |
| 0b10             | 0b10           | 0b1X            | EL1           | EL2           | EL1           |
| 0b10             | 0b11           | XX              | EL2           | EL2           | EL2           |
| 0b11             | XX             | XX              | EL3           | EL3           | EL3           |

## RMYXZK

RYZJQX

When a write to the Profiling Buffer by the Statistical Profiling Unit generates an Alignment fault or MMU fault, the PE sets PMBPTR\_EL1 to the faulting address.

The last byte of the last complete sample record, including any padding bytes after the record, is at most 2 (PMSIDR\_EL1.MaxSize) bytes below PMBPTR\_EL1.

If PMBPTR\_EL1 does not point to the first byte after the last complete record, including any padding after the record, then PMBSR\_ELx.DL is set to 1. Otherwise, PMBSR\_ELx.DL is set to an IMPLEMENTATION DEFINED choice of 0 and 1. ELx is defined by RHJXHT. See also Table D17-6.

When FEAT\_SPE\_EXC is implemented and any of the following are true, then the SPE Profiling exception is enabled and pending:

- All of the following are true:
- -EL3 is implemented.
- -MDCR\_EL3.PMSEE is 0b10 or 0b11 .
- -PMBSR\_EL3.S is 1.

## In this case:

- -The target Exception level is EL3.
- -If all of the following are true, then the SPE Profiling exception is unmasked :
- -The PE is executing at EL2, EL1, or EL0.
- -The PE is in Non-debug state.
- All of the following are true:
- -EL3 is not implemented or MDCR\_EL3.PMSEE is not 0b00 .
- -EL2 is implemented and enabled in the current Security State.
- -PMSCR\_EL2.EE is 0b10 or 0b11 .
- -PMBSR\_EL2.S is 1.

## In this case:

- -The target Exception level is EL2.
- -If the PE is executing in the owning Security state, the PE is in Non-debug state, and any of the following are true, then the SPE Profiling exception is unmasked:
- -The PE is executing at EL1 or EL0.
- -The PE is executing at EL2, PMSCR\_EL2.EE is 0b11 , PMSCR\_EL2.KE is 1, and PSTATE.PM is 0.
- All of the following are true:
- -EL3 is not implemented or MDCR\_EL3.PMSEE is not 0b00 .
- -EL2 is not implemented, or EL2 is disabled in the current Security State, or PMSCR\_EL2.EE is not 0b00 .
- -PMSCR\_EL1.EE is 0b11 .

IGMBMC

- -

PMBSR\_EL1.S is 1.

## In this case:

- -The target Exception level is EL2 if the Effective value of HCR\_EL2.TGE is 1, and EL1 otherwise.
- -If the PE is executing in the owning Security state, the PE is in Non-debug state, and any of the following are true, then the SPE Profiling exception is unmasked:
- -The PE is executing at EL0.
- -The PE is executing at EL1, PMSCR\_EL1.KE is 1, and PSTATE.PM is 0.

When none of the above apply, the SPE Profiling exception is disabled and not pending.

When the SPE Profiling exception is enabled and unmasked, the SPE Profiling exception will be taken to the target Exception level .

When the SPE Profiling exception is enabled and not unmasked, then the SPE Profiling exception is masked . The SPE Profiling exception is always masked at EL3.

The pseudocode function CheckForSPEException() shows this.

Table D17-8, Table D17-9, and Table D17-10 show the SPE Profiling exception enable and masking for each Exception level, for the Effective values of each of the PMBSR\_EL1.S, PMBSR\_EL2.S, and PMBSR\_EL3.S bits respectively. Each column in the left side of the table refers to the Effective value of a field in a System register or PSTATE. If FEAT\_SPE\_EXC is not implemented, then the Effective values of PMBSR\_EL2.S and PMBSR\_EL3.S are 0. In Table D17-8, the IRQ column represents the state of the PMBIRQ signal. Table D17-8 does also apply when FEAT\_SPE\_EXC is disabled. In these cells for each row representing a combination of control bits:

HIGH

LOW

Means the SPE Profiling exception is disabled and the SPE interrupt request is enabled and asserted.

Means the SPE interrupt request is not asserted.

The other columns in the right side of the table represent an Exception level the exception is taken from. In each cell for each of these columns for each row representing a combination of control bits:

None

Means the exception is disabled. For Table D17-9 and Table D17-10 this means that the PMBSR\_EL3.S or PMBSR\_EL2.S bit (as applicable) is ignored.

B

Means the exception is enabled and masked by PSTATE.PM. The exception remains pending.

C

Means the exception is enabled and masked regardless of the value of PSTATE.PM. The exception remains pending.

ELx

Means the exception is enabled, is not masked, and is taken to ELx.

n/a

Not applicable. The PE cannot be executing at this Exception level for the specified value of HCR\_EL2.TGE.

## Table D17-8 SPE Profiling exception and interrupt, taken from EL0, EL1, EL2 or EL3, when the Effective value of PMBSR\_EL1.S is 1

| MDCR_EL3. PMSEE   | PMSCR_EL2. EE   | HCR_EL2. TGE   |      |    | PSTATE. PM   | IRQ   | Taken from   | Taken from   |      |      |
|-------------------|-----------------|----------------|------|----|--------------|-------|--------------|--------------|------|------|
| MDCR_EL3. PMSEE   | PMSCR_EL2. EE   | HCR_EL2. TGE   | EE   | KE | PSTATE. PM   | IRQ   | EL0          | EL1          | EL2  | EL3  |
| 0b00              | XX              | 0b0            | XX   | X  | X            | HIGH  | None         | None         | None | None |
| 0b00              | XX              | 0b1            | XX   | X  | X            | HIGH  | None         | n/a          | None | None |
| !=0b00            | 0b00            | 0b0            | XX   | X  | X            | HIGH  | None         | None         | None | None |
| !=0b00            | 0b00            | 0b1            | XX   | X  | X            | HIGH  | None         | n/a          | None | None |
| !=0b00            | !=0b00          | 0b0            | 0b0X | X  | X            | HIGH  | None         | None         | None | None |

| MDCR_EL3. PMSEE   | PMSCR_EL2. EE   | HCR_EL2. TGE   |      |     | PSTATE. PM   | IRQ   | Taken from   | Taken from   |      |      |
|-------------------|-----------------|----------------|------|-----|--------------|-------|--------------|--------------|------|------|
| MDCR_EL3. PMSEE   | PMSCR_EL2. EE   | HCR_EL2. TGE   | EE   | KE  | PSTATE. PM   | IRQ   | EL0          | EL1          | EL2  | EL3  |
| !=0b00            | !=0b00          | 0b0            | 0b1X | 0b0 | X            | LOW   | EL1          | C            | C    | C    |
| !=0b00            | !=0b00          | 0b0            | 0b1X | 0b1 | 0b0          | LOW   | EL1          | EL1          | C    | C    |
| !=0b00            | !=0b00          | 0b0            | 0b1X | 0b1 | 0b1          | LOW   | EL1          | B            | C    | C    |
| !=0b00            | !=0b00          | 0b1            | 0b0X | X   | X            | HIGH  | None         | n/a          | None | None |
| !=0b00            | !=0b00          | 0b1            | 0b1X | X   | X            | LOW   | EL2          | n/a          | C    | C    |

## Table D17-9 SPE Profiling exception, taken from EL0, EL1, EL2 or EL3, when the Effective value of PMBSR\_EL2.S is 1

| MDCR_EL3.PMSEE   | PMSCR_EL2   | PMSCR_EL2   | HCR_EL2.TGE   | PSTATE.PM   | Taken from   | Taken from   | Taken from   | Taken from   |
|------------------|-------------|-------------|---------------|-------------|--------------|--------------|--------------|--------------|
| MDCR_EL3.PMSEE   | EE          | KE          | HCR_EL2.TGE   | PSTATE.PM   | EL0          | EL1          | EL2          | EL3          |
| 0b00             | XX          | X           | 0b0           | X           | None         | None         | None         | None         |
| 0b00             | XX          | X           | 0b1           | X           | None         | n/a          | None         | None         |
| !=0b00           | 0b0X        | X           | 0b0           | X           | None         | None         | None         | None         |
| !=0b00           | 0b0X        | X           | 0b1           | X           | None         | n/a          | None         | None         |
| !=0b00           | 0b10        | X           | 0b0           | X           | EL2          | EL2          | C            | C            |
| !=0b00           | 0b10        | X           | 0b1           | X           | EL2          | n/a          | C            | C            |
| !=0b00           | 0b11        | 0b0         | 0b0           | X           | EL2          | EL2          | C            | C            |
| !=0b00           | 0b11        | 0b0         | 0b1           | X           | EL2          | n/a          | C            | C            |
| !=0b00           | 0b11        | 0b1         | 0b0           | 0b0         | EL2          | EL2          | EL2          | C            |
| !=0b00           | 0b11        | 0b1         | 0b0           | 0b1         | EL2          | EL2          | B            | C            |
| !=0b00           | 0b11        | 0b1         | 0b1           | 0b0         | EL2          | n/a          | EL2          | C            |
| !=0b00           | 0b11        | 0b1         | 0b1           | 0b1         | EL2          | n/a          | B            | C            |

Table D17-10 SPE Profiling exception, taken from EL0, EL1, EL2 or EL3, when the Effective value of PMBSR\_EL3.S is 1

| MDCR_EL3.PMSEE   | HCR_EL2.TGE   | Taken from   | Taken from   | Taken from   | Taken from   |
|------------------|---------------|--------------|--------------|--------------|--------------|
|                  |               | EL0          | EL1          | EL2          | EL3          |
| 0b0X             | 0b0           | None         | None         | None         | None         |
| 0b0X             | 0b1           | None         | n/a          | None         | None         |
| 0b10             | 0b0           | EL3          | EL3          | EL3          | C            |
| 0b10             | 0b1           | EL3          | n/a          | EL3          | C            |
| 0b11             | 0b0           | EL3          | EL3          | EL3          | C            |
| 0b11             | 0b1           | EL3          | n/a          | EL3          | C            |

When FEAT\_SPE\_EXC is implemented, the target Exception level might be the same as the owning Exception level, or a higher Exception level, or a lower Exception level. For example:

- The owning Exception level is EL1, but EL2 triages all SPE Profiling exceptions and so programs PMSCR\_EL2.EE to 0b11 .

ISFJPD

- The owning Exception level is EL2, because EL2 has mapped the Profiling Buffer in the EL2 translation regime, but EL1 can handle all non-MMU management events, and so EL2 programs PMSCR\_EL2.EE to 0b10 .

RYMRRB

When FEAT\_SPE\_EXC is implemented, SPE Profiling exceptions are taken asynchronously and precisely.

RNXPMV

When FEAT\_SPE\_EXC is implemented, if an SPE Profiling exception is enabled and unmasked, and all of the following are true, then the SPE Profiling exception will be taken before an instruction C completes execution:

- Instruction A is one of the following:

- Adirect read of the corresponding PMBSR\_ELx register that observes that the S bit is 1.

- Adirect write of the corresponding PMBSR\_ELx register that sets the S bit to 1.

- A PSB CSYNC instruction that synchronizes a profiling operation that causes a Profiling Buffer management event that sets the corresponding PMBSR\_ELx.S bit to 1. For more information, see Synchronization and Statistical Profiling.

- C follows in program order immediately after a Context synchronization event B .

- B is in program order after A .

Otherwise, the SPE Profiling exception is taken in finite time.

RTSJRP

If any of the following are true, then the SPE interrupt request ( PMBIRQ ) is enabled and driven from PMBSR\_EL1.S:

- FEAT\_SPE\_EXC is not implemented.

- EL3 is implemented and MDCR\_EL3.PMSEE is 0b00 .

- EL2 is implemented, PMSCR\_EL2.EE is 0b00 , and any of the following are true:

- The Effective value of SCR\_EL3.NS is 1.

- The Effective value of SCR\_EL3.{NS, EEL2} is {0, 1}.

This applies even when the current Exception level is EL3.

- PMSCR\_EL1.EE is 0b00 .

Otherwise, if FEAT\_SPE\_EXC is implemented, then the SPE interrupt request is disabled and driven LOW (inactive). The pseudocode function SPEInterruptEnabled() shows this.

IGRLRX

When the PMBIRQ is enabled:

- Adirect write that sets PMBSR\_EL1.S to 1 causes the interrupt to be asserted.

- PMBIRQ will remain asserted until software clears PMBSR\_EL1.S to 0.

ISMLLS

If a Generic Interrupt Controller (GIC) is implemented, PMBIRQ must be configured as a Private Peripheral Interrupt (PPI) in a multiprocessor system. PMBIRQ is signaled by the PE that implements the SPU.

Note

Astandard PPI number is allocated by the Arm ® Base System Architecture (BSA).

## D17.8.1 Prioritization of Profiling Buffer management events

RDTGVZ

Where multiple synchronous Profiling Buffer management events occur on writing a sample record, the PE prioritizes them as follows (from highest to lowest priority):

1. Synchronous fault.

2. Synchronous External abort.

3. Buffer full event.

IXQRTS

Asynchronous External aborts are not prioritized with respect to other events.

ICTRLW

When a Profiling Buffer management event generates an SPE interrupt request, the priority of the SPE interrupt request is separately managed by the interrupt controller. Do not confuse the prioritization of Profiling Buffer management events with the prioritization of SPE interrupt requests by an interrupt controller.

## D17.8.2 Buffer full event

If, after writing a sample record, there is not sufficient space in the Profiling Buffer for a sample record of the size indicated by PMSIDR\_EL1.MaxSize, and PMBSR\_ELx.S is 0, a Profiling Buffer management event is generated:

- PMBSR\_ELx.S is set to 1.
- PMBSR\_ELx.EC is set to 0b000000 , other buffer management event.
- The BSC field of PMBSR\_ELx.MSS is set as follows: -PMBSR\_ELx.BSC is set to 0b000001 , buffer filled.
- PMBPTR\_EL1 is set to the first byte after the last complete sample record, which can include any padding that the implementation uses to force alignment. PMBSR\_ELx.DL is unchanged.
- The other fields in PMBSR\_ELx and the other PMBSR\_ELx registers are unchanged.
- The SAMPLE\_BUFFER\_FULL PMU event is generated.

ELx is defined by RHJXHT. See also Table D17-7.

That is, the Profiling Buffer management event is generated when the PE writes past the write limit pointer minus 2 (PMSIDR\_EL1.MaxSize) . The SPU never writes beyond the write limit pointer.

For more information, see Restrictions on the current write pointer.

## D17.8.3 Faults and watchpoints

Table D17-11 lists the faults that might be generated by a write to the Profiling Buffer by the SPU.

Writes to the Profiling Buffer never generate watchpoints.

## Table D17-11 Faults

| Fault                                                                           | Conditions                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
|---------------------------------------------------------------------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| Translation                                                                     | The translation of a virtual address to a physical address might generate a Translation fault.                                                                                                                                                                                                                                                                                                                                                                                       |
| Address Size                                                                    | The translation of a virtual address to a physical address might generate an Address Size fault.                                                                                                                                                                                                                                                                                                                                                                                     |
| Alignment                                                                       | If PMBPTR_EL1 is not aligned to an IMPLEMENTATION DEFINED minimum alignment, the behavior is UNPREDICTABLE and a write to the Profiling Buffer by the SPU might generate an Alignment fault. For more information, see Restrictions on the current write pointer.                                                                                                                                                                                                                    |
| Permission                                                                      | Writes to the Profiling Buffer are made as privileged writes. If the write does not have write permission, a Permission fault is generated. The value of PSTATE.PAN is ignored and treated as zero. If the SPU does not manage the dirty state in translation tables, then accesses ignore the Dirty Bit Modifier bit in Page and Block descriptors and an access might as a result generate a Permission fault. For more information, see Hardware management of the dirty state. a |
| Access flag                                                                     | If the SPU does not manage the Access flag in translation tables or hardware management of the Access flag state is disabled for the owning translation regime, then any access to a Page or Block with the Access Flag bit set to 0 in a descriptor will generate an Access Flag fault. For more information, see The Access flag. a                                                                                                                                                |
| TLB Conflict fault                                                              | IMPLEMENTATION DEFINED.                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| Unsupported atomic hardware update fault                                        | If hardware update of the translation tables is not guaranteed atomic in regard to other agents that access the memory, the translation of a virtual address to a physical address might generate an Unsupported atomic hardware update fault.                                                                                                                                                                                                                                       |
| External abort on translation table walk, translation table update, or GPT walk | The translation of a virtual address to a physical address might generate an External abort on the translation table walk, translation table update, or GPT walk, and be treated as a synchronous MMUfault. For more information, see External aborts.                                                                                                                                                                                                                               |
| Granule Protection Check                                                        | The translation of a virtual address to a physical address might generate a GPC fault.                                                                                                                                                                                                                                                                                                                                                                                               |

If a write to the Profiling Buffer generates an Alignment fault or MMU fault, including a Granule Protection Check (GPC) fault, and PMBSR\_ELx.S is 0, then all of the following occur:

- AProfiling Buffer management event is generated. This sets PMBSR\_ELx.S is set to 1.
- PMBSR\_ELx.EC is set to one of:
- -0b011110 , GPC fault, other than a Granule Protection Fault (GPF), on write to the Profiling Buffer.
- -0b100100 , stage 1 Data Abort on write to the Profiling Buffer.
- -0b100101 , stage 2 Data Abort on write to the Profiling Buffer.

AGPFontranslation table walk or update is reported as either a stage 1 or stage 2 Data Abort, as appropriate. Other GPFs are reported as a stage 1 Data Abort.

- The FSC field of PMBSR\_ELx.MSS is set as follows:
- -PMBSR\_ELx.FSC is set to indicate the type of the fault.
- If FEAT\_THE is implemented, then PMBSR\_ELx.TopLevel is set as follows:
- -1, for a stage 2 Permission fault due to a TopLevel check.
- -0, otherwise.
- If FEAT\_THE is implemented, then PMBSR\_ELx.AssuredOnly is set as follows:
- -1, for a stage 2 Permission fault due to the AssuredOnly attribute.
- -0, otherwise.
- PMBPTR\_EL1 is set to the address that generated the fault.
- If PMBPTR\_EL1 is not the address of the first byte after the last complete sample record, written by the SPU and including any padding used to force alignment, then PMBSR\_ELx.DL is set to 1. Otherwise, PMBSR\_ELx.DL is unchanged.

If the MMU fault is an External abort on a translation table walk, translation table update, or GPT walk, then it is IMPLEMENTATION DEFINED whether PMBSR\_ELx.EA is set to 1 or unchanged.

The value of ELx depends on the type of event, and is defined by RHJXHT. The other fields in PMBSR\_ELx and the other PMBSR\_ELx registers are unchanged.

Note

Each of these faults causes a Profiling Buffer management event, not an actual MMU fault exception. The ESR and FAR registers are unchanged.

For more information, see MMU fault-checking sequence.

## D17.8.3.1 Hardware management of dirty state and the Access flag by the Statistical Profiling Extension

If FEAT\_SPEv1p3 is implemented, address translations performed by the SPU manage dirty state and the Access flag in Block and Page descriptors. Otherwise, it is IMPLEMENTATION DEFINED whether address translations performed by the SPU manage dirty state and the Access flag. This is discoverable by software using PMBIDR\_EL1.F. See Hardware management of the dirty state and Hardware management of the Access flag.

If the SPU manages dirty state and hardware management of dirty state is enabled for the owning translation regime, then the SPU can speculatively update the Translation Table descriptor for any Page or Block in the Statistical Profiling buffer before writing data to it, if the write is otherwise permitted. This includes the case where a buffer management event means the SPU stops writing data before the page or block is written to. For more information, see The Profiling Buffer.

If FEAT\_HAFT is implemented and the SPU manages dirty state, for an architecturally executed memory access that is translated by a translation stage with Table descriptor Access flag hardware management enabled, the SPU sets the Access flag to 1 in all Table descriptors accessed during the translation table walk for that access that have the Access flag set to 0.

## D17.8.4 External aborts

RJFYNW

When a write to the Profiling Buffer generates an External abort, including an External abort on a translation table walk, translation table update, or GPT walk, the permitted IMPLEMENTATION DEFINED behaviors are:

- The External abort is ignored.

- The External abort generates an SError exception.

- For an External abort on a translation table walk, translation table update, or GPT walk only, the External abort generates a MMU fault.

- If FEAT\_SPEv1p3 is not implemented, the External abort is reported to the SPU. The SPU generates a Profiling Buffer management event.

IKDMQG PMBIDR\_EL1.EA indicates to software the mechanism used by the SPU when a write to memory generates an External abort that does not generate a MMU fault.

Note

The originator of the abort might additionally take other actions. For more information, see Arm ® Reliability, Availability, and Serviceability (RAS) System Architecture, for A-profile architecture (ARM IHI 0100).

## D17.8.4.1 The External abort is ignored

IVPLMK

If the External abort is ignored, this has the same visible behavior as when a write does not generate any External abort. PMBSR\_ELx is not modified.

## D17.8.4.2 The External abort generates an SError exception

IZGGXW

If a write to the Profiling Buffer generates an External abort that is taken as an SError exception, the PE takes the SError exception as normal, and PMBSR\_ELx fields are unchanged.

## D17.8.4.3 The External abort generates a MMU fault

IQNXKH

When an External abort on a translation table walk, translation table update, or GPT walk genarates a MMU fault, the behavior is as described by Faults and watchpoints.

## D17.8.4.4 The External abort is reported to the SPU

ITCPLL The behavior in this section is not permitted if FEAT\_SPEv1p3 is implemented.

RBPFPN

If a write to the Profiling Buffer generates an External abort that is reported to the SPU:

- The External abort bit, PMBSR\_ELx.EA, is set to 1.

- The SPU stops writing sample records to the Profiling Buffer. It is IMPLEMENTATION DEFINED whether an External abort on a write to the Profiling Buffer is reported as synchronous or asynchronous:

- The External abort is reported as synchronous if PMBPTR\_EL1 is set to the address that was externally aborted.

- The External abort is reported as asynchronous if PMBPTR\_EL1 is not guaranteed to be set to the address that was externally aborted.

- If the External abort is reported as asynchronous or PMBPTR\_EL1 is not the address of the first byte of the sample record being written by the SPU, then PMBSR\_ELx.DL is set to 1. Otherwise, PMBSR\_ELx.DL is unchanged.

Note

Following an External abort reported asynchronously to the SPU, software must not assume that any valid data has been written to the Profiling Buffer.

- If PMBSR\_ELx.S is 0, a buffer management event is generated:

- PMBSR\_ELx.S is set to 1.

- PMBSR\_ELx.EC is set to one of:

- If the External abort is on a GPT fetch, 0b011110 , Granule Protection Check fault on write to Profiling Buffer, other than Granule Protection Fault (GPF).

- If the External abort is on a stage 2 translation table access, 0b100101 , stage 2 Data Abort on write to buffer.

- Otherwise, 0b100100 , stage 1 Data Abort on write to buffer.

- PMBSR\_ELx.MSS is set as follows:

- PMBSR\_ELx.FSC is set to indicate a synchronous or asynchronous External abort.

IXPWQC

ELx is defined by RHJXHT. See also Table D17-6. Other fields in PMBSR\_ELx and the other PMBSR\_ELx registers are unchanged.

If External aborts are reported as asynchronous:

- The External abort might not be received until after a first Profiling Buffer management event has set PMBSR\_ELx.S to 1.
- Writes to the buffer might generate a second Profiling Buffer management event after the External abort has set PMBSR\_ELx.S to 1.

## D17.8.5 Access not allowed

An SPU might detect that a write to the Profiling Buffer cannot occur, usually because software has created an architecturally UNPREDICTABLE situation. In these cases, when profiling data is generated, the SPU might discard the data and generate a Profiling Buffer management event:

- If PMBSR\_ELx.S is 0, then all of the following occur:
- -PMBSR\_ELx.S is set to 1.
- -PMBSR\_ELx.DL is set to 1.
- -PMBSR\_ELx.EC is set to 0x00 , other buffer management event.
- -PMBSR\_ELx.BSC is set to 0b000000 , access not allowed.
- The other fields in PMBSR\_ELx and the other PMBSR\_ELx registers are unchanged.

ELx is defined by RHJXHT. See also Table D17-7.

## D17.8.6 Implementation defined reason

An implementation might include support for generating Profiling Buffer events for IMPLEMENTATION DEFINED reasons. These should normally be disabled unless enabled by IMPLEMENTATION DEFINED controls. The PMBSR\_ELx.EC code 0x1F is reserved for this purpose.