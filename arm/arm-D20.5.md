## D20.5 Error synchronization event

| R GRJVN   | An Error synchronization event is generated by any of the following:                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
|-----------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| I PMGVM   | In addition to generating an Error synchronization event, the ESB instruction might additionally record and then clear a masked pending asynchronous SError exception. This is also referred to as deferring the pending asynchronous SError exception.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| R WPPWC   | Asynchronizable error is one of a subset of errors specific to the implementation that are synchronized by Error synchronization events, generated by an instruction executed on the same PE as the Error synchronization events. Note: Synchronizable error must not be confused with a synchronous error exception. An Error exception for a synchronizable error might be taken asynchronously.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| R BZPTV   | If the Error exception for a synchronizable error is taken in program order after the Error synchronization event completes, and either physical SError exceptions are unmasked when the Error synchronization event occurs or the Error exception is taken synchronously, then all of the following are true: • The instruction that generated the synchronizable error is in program order after the Error synchronization event. • On completion of the Error synchronization event, the PE state and memory system state are consistent with the                                                                                                                                                                                                                                                                                                                                                                            |
| R ZRHDD   | If the Error exception for a synchronizable error is taken asynchronously as an SError exception, physical SError exceptions are masked when the Error synchronization event occurs, and the SError exception is not pending when the Error synchronization event completes, then all of the following are true: • The instruction that generated the synchronizable error is in program order after the Error synchronization event. • On completion of the Error synchronization event, the PE state and memory system state are consistent with the PE having executed all instructions in program order before the Error synchronization event. The SError exception is not pending when the Error synchronization event completes if a subsequent read of ISR_EL1.A                                                                                                                                                        |
|           | or ISR.A returns 0b0 .                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| R YCJTN   | If the Error exception for a synchronizable error is taken asynchronously as an SError exception, the Error synchronization event is generated by an ESB instruction executed when physical SError exceptions are masked, and the ESB instruction does not set DISR_EL1.A or DISR.A to 0b1 , then all of the following are true: • The instruction that generated the synchronizable error is in program order after the ESB . • On completion of the ESB , the PE state and memory system state are consistent with the PE having executed all instructions in program order before the ESB . Taken in program order after the Error synchronization event completes means: • For an Error synchronization event generated by an ESB instruction, the exception is taken in program order after the instruction. • For an Error synchronization event generated by an exception return instruction when FEAT_IESB implemented, |
| R NFKMQ   | the exception is taken in program order after the instruction. • For an Error synchronization event generated by an exception entry when FEAT_IESB is implemented, one of the following is true: - The exception is taken in program order strictly after the first instruction of the exception handler at the exception vector address. - The exception is taken from the first instruction of the exception handler at the exception vector address and the ESR_ELx.IESB syndrome bit is recorded as 0b0 .                                                                                                                                                                                                                                                                                                                                                                                                                   |
| I QZSHG   | The definition of synchronizable error means that if the error that is a synchronizable error is generated by an instruction in program order before the Error synchronization event, then either the Error exception is taken before the Error synchronization event, or on executing the Error synchronization event the following apply:                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |

ISQCFG

RBLRTM

- If physical SError exceptions are unmasked or the Error exception is taken synchronously, then the Error synchronization event ensures that the Error exception is not taken in program order after the Error synchronization event. This allows isolation of the software affected by the error.
- If physical SError exceptions are masked and the Error exception is taken asynchronously, then:
- -If the Error synchronization event was generated by an ESB , then the error is recorded in DISR\_EL1 or DISR. Software can use the PE error state recorded in DISR\_EL1 or DISR to determine what recovery is possible.
- -Otherwise, the Error exception is pending when the Error synchronization event completes.

The SError exception might have been pending before or made pending by the Error synchronization event.

The definition does not mean that if the error is generated by a instruction in program order after the Error synchronization event, then the Error exception will only be taken after the Error synchronization event. The Error exception might be taken before the Error synchronization event, if the PE speculated past the Error synchronization event and speculatively executed the instruction that generated the error. This might cause software to generate a false failure. Error synchronization events are not speculation barriers.

The criteria for the PE error state mean that if the PE reports the PE error state as one of the following, then the error must be either explicitly or implicitly a synchronizable error:

- Unrecoverable state (UEU).
- Recoverable state (UER).
- Restartable state (UEO).

This is because whether the error is a synchronizable error is a criterion for Unrecoverable state (UEU), and the criteria for Recoverable state (UER) and Restartable state (UEO) satisfy the definition of synchronizable error.

For other physical errors:

- An error that has been silently propagated by the PE and is not reported as either IMPLEMENTATION DEFINED syndrome or Uncategorized error must be reported as Uncontainable (UC) and is not containable even if the error is a synchronizable error. Software must assume the error has been silently propagated even if the error is a synchronizable error.
- It is IMPLEMENTATION SPECIFIC whether an error reported with an ESR\_ELx.ISS syndrome that is IMPLEMENTATION DEFINED syndrome or Uncategorized error is a synchronizable error.
- The following errors have not been consumed by the PE:
- -A Deferred error .
- -A Corrected error .
- -An Error exception from a read by hardware speculation that does not corrupt the state of the PE.

Software can recover execution from these errors regardless of whether the error is a synchronizable error.

- An implementation might have other IMPLEMENTATION DEFINED Error exception and other sources of SError exception, see RFNVVJ. If an IMPLEMENTATION DEFINED SError exception is generated by a level-sensitive interrupt signal, then the SError exception cannot be a synchronizable error.

## IVFFYW An Error synchronization event might operate as follows:

1. The PE ensures that any synchronizable error generated by an instruction in program order before the Error synchronization event has caused a physical SError exception to become pending.
2. If a physical SError exception is pending for a synchronizable error and generated by an instruction in program order before the Error synchronization event, and physical SError exceptions are not masked at the current Exception level, then the physical SError exception is taken before completion of the Error synchronization event. The SError exception might have been made pending by the Error synchronization event, or might have been pending before the Error synchronization event.
3. RNPPGJ If an SError exception for a synchronizable error is pending after completing the Error synchronization event generated by an ESB instruction, and physical SError exceptions are masked at the current Exception level, then the ESB instruction performs the following steps:
1. The pending physical SError exception is recorded in DISR\_EL1 or DISR. This includes the PE error state that the pending Error exception would record if taken.
2. The DISR\_EL1.A bit or DISR.A bit is set to 0b1 .
3. The pending state of the physical SError exception is cleared.

The SError exception might have been made pending by the Error synchronization event, or might have been pending before the Error synchronization event.

The criteria for ESB recording the PE error state in DISR\_EL1 or DISR are the same as for that for recording the PE error state in ESR\_ELx or DFSR when an SError exception taken to the current execution state.

| R KNWBN   | If an SError exception is taken as part of an Error synchronization event generated by an ESB instruction, then the ESB instruction address is the preferred return address of the exception. For the definition of the preferred return address for an exception, see Preferred return address.   |
|-----------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| R SFHDS   | On executing an ESB instruction when SError exceptions are masked, any pending SError exception generated by an error that is not a synchronizable error: • Remains pending after completion of the Error synchronization event. • Does not update DISR_EL1 or DISR.                               |
| I CQKXL   | The Error recovery interrupt, Fault handling interrupt, and Critical Error interrupt interrupts described by RAS System Architecture are asynchronous interrupts, and so are not synchronizable errors.                                                                                            |
| I BBGXN   | If multiple SError exception conditions are pending, then an Error synchronization event synchronizes all errors that are synchronizable errors.                                                                                                                                                   |
| S VFHGT   | Software must be aware that an SError exception taken at an Error synchronization event or recorded in the DISR_EL1 or DISR register by an ESB instruction might have been generated by hardware speculation of an instruction in program order after the Error synchronization event.             |

## D20.5.1 ESB and virtual SError exceptions

RLLLVR

If all of the following are true, then an ESB instruction executed at EL0 or EL1 synchronizes a pending virtual SError exception:

- EL2 is implemented and enabled in the current Security state.
- Any of the following are true:
- -EL2 is using AArch64, HCR\_EL2.TGE is 0b0 , HCR\_EL2.VSE is 0b1 and either:
- -HCR\_EL2.AMO is 0b1 .
- -FEAT\_DoubleFault2 is implemented and the Effective value of HCRX\_EL2.TMEA is 0b1 .
- -EL2 is using AArch32, HCR.AMO is 0b1 , HCR.TGE is 0b0 , and HCR.VA is 0b1 .
- The VSESR\_EL2 and, if implemented, VDFSR registers are writable.

In these cases, a virtual SError exception is pending, and the following occur when an ESB instruction is executed at EL0 or EL1:

- If the virtual SError exception is unmasked at the current Exception level, then the exception is taken before the completion of the ESB instruction.
- If the virtual SError exception is masked at the current Exception level, then all the following occur:
- -HCR\_EL2.VSE or HCR.VA cleared to 0b0 .
- -The virtual SError exception syndrome from VSESR\_EL2 or VDFSR is recorded in VDISR\_EL2 or VDISR respectively.
- -VDISR\_EL2.A or VDISR.A is set to 0b1 to indicate the virtual SError exception was pending prior to the execution of the ESB instruction.

RGXHYX If all of the following are true, then it is IMPLEMENTATION DEFINED whether or not an ESB instruction executed at EL0 or EL1 synchronizes a pending virtual SError exception:

- EL2 is implemented and enabled in the current Security state.
- Any of the following are true:
- -EL2 is using AArch64, HCR\_EL2.TGE is 0b0 , HCR\_EL2.VSE is 0b1 and either:
- -HCR\_EL2.AMO is 0b1 .
- -FEAT\_DoubleFault2 is implemented and the Effective value of HCRX\_EL2.TMEA is 0b1 .
- -EL2 is using AArch32, HCR.AMO is 0b1 , HCR.TGE is 0b0 , and HCR.VA is 0b1 .
- VSESR\_EL2 and, if implemented, VDFSR registers are implemented as RAZ/WI.

In these cases, a virtual SError exception is pending. If the IMPLEMENTATION DEFINED choice is that the ESB instruction synchronizes a pending virtual SError exception, then the following occur when an ESB instruction is executed at EL0 or EL1:

- If the virtual SError exception is unmasked at the current Exception level, then the exception is taken before the completion of the ESB instruction.
- If the virtual SError exception is masked at the current Exception level, then all the following occur:

IVKQGL

- -HCR\_EL2.VSE or HCR.VA cleared to 0b0 .
- -The virtual SError exception syndrome in VDISR\_EL2 or VDISR is set to zero.
- -VDISR\_EL2.A or VDISR.A is set to 0b1 to indicate the virtual SError exception was pending prior to the execution of the ESB instruction.

If the IMPLEMENTATION DEFINED choice is that the ESB instruction does not synchronize a pending virtual SError exception, then an ESB instruction executed at EL0 or EL1 ignores the pending virtual SError exception and the virtual SError exception stays pending.

See also Syndrome registers.

If both a virtual SError exception and a physical SError exception are pending as described in RLLLVR and Error synchronization event, then the physical SError exception is not masked at the current Exception level, because this is not possible when a virtual SError exception is pending. This means that:

- If the virtual SError exception is masked at the current Exception level, then the physical SError exception will be taken before the ESB instruction completes and HCR\_EL2.VSE, HCR.VA, VDISR\_EL2, and VDISR are unchanged.
- If the virtual SError exception is not masked at the current Exception level, then it is IMPLEMENTATION DEFINED which of the virtual SError or physical SError exceptions is taken before the ESB instruction completes. If the virtual SError exception is taken and, after taking the exception to EL1, the physical SError exception is still pending, then the physical SError exception is still not masked and will be taken.

Avirtual SError exception injected using HCR\_EL2.VSE has priority over a delegated SError exception injected using SCR\_EL3.DSE when both are synchronized by ESB .

## D20.5.2 ESB and delegated SError exceptions

RKKPVY

If all of the following are true, then an ESB instruction executed at EL0, EL1, or EL2 synchronizes a pending delegated SError exception:

- FEAT\_E3DSE is implemented.
- SCR\_EL3.{EnDSE, DSE} is { 0b1 , 0b1 }.
- VSESR\_EL3 is writable.

In this case, a delegated SError exception is pending, and the following occur when an ESB instruction is executed at EL0, EL1, or EL2:

- If the delegated SError exception is unmasked at the current Exception level, then the exception is taken before the completion of the ESB instruction.
- If the delegated SError exception is masked at the current Exception level, then all the following occur:
- -SCR\_EL3.DSE is cleared to 0b0 .
- -The delegated SError exception syndrome from VSESR\_EL3 is recorded in VDISR\_EL3.
- -VDISR\_EL3.A is set to 0b1 to indicate the delegated SError exception was pending prior to the execution of the ESB instruction.

RGGVCW If all of the following are true, then it is IMPLEMENTATION DEFINED whether or not an ESB instruction executed at EL0, EL1, or EL2 synchronizes a pending delegated SError exception:

- FEAT\_E3DSE is implemented.
- SCR\_EL3.{EnDSE, DSE} is { 0b1 , 0b1 }.
- The VSESR\_EL3 register is implemented as RAZ/WI.

In this case, a delegated SError exception is pending. If the IMPLEMENTATION DEFINED choice is that the ESB instruction synchronizes a pending delegated SError exception, then the following occur when an ESB instruction is executed at EL0, EL1, or EL2:

- If the delegated SError exception is unmasked at the current Exception level, then the exception is taken before the completion of the ESB instruction.
- If the delegated SError exception is masked at the current Exception level, then all the following occur:
- -SCR\_EL3.DSE is cleared to 0b0 .
- -The delegated SError exception syndrome in VDISR\_EL3 is set to zero.
- -VDISR\_EL3.A is set to 0b1 to indicate the delegated SError exception was pending prior to the execution of the ESB instruction.

IVYGVB

RRNZWY

RRPBWR

RJQSKQ

IFWZHV

If the IMPLEMENTATION DEFINED choice is that the ESB instruction does not synchronize a pending delegated SError exception, then an ESB instruction executed at EL1 or EL2 ignores the pending delegated SError exception and the delegated SError exception stays pending.

See also Syndrome registers.

If both a delegated SError exception and a physical SError exception are pending as described in RKKPVY and Error synchronization event, then the physical SError exception is not masked at the current Exception level, because this is not possible when a delegated SError exception is pending. This means that:

- If the delegated SError exception is masked at the current Exception level, then the physical SError exception will be taken before the ESB instruction completes and SCR\_EL3.DSE and VDISR\_EL3 are unchanged.
- If the delegated SError exception is not masked at the current Exception level, then it is IMPLEMENTATION DEFINED which of the delegated SError or physical SError exceptions is taken before the ESB instruction completes. If the delegated SError exception is taken and, after taking the exception to EL1 or EL2, the physical SError exception is still pending, then the physical SError exception is still not masked and will be taken.

Avirtual SError exception injected using HCR\_EL2.VSE has priority over a delegated SError exception injected using SCR\_EL3.DSE when both are synchronized by ESB .

## D20.5.3 Extension for synchronization at exception entry and return

| D DPSJR   | The rules in this section apply when FEAT_IESB is implemented.                                                                                                                                                                                                                                            |
|-----------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| I WDSBL   | An implicit Error synchronization event has no effect on DISR_EL1 or VDISR_EL2.                                                                                                                                                                                                                           |
| R KJWNS   | When FEAT_DoubleFault is implemented, the PE is in Non-debug state, and the Effective value of SCR_EL3.NMEA is 1, then the Effective value of SCTLR_EL3.IESB is 1.                                                                                                                                        |
| R HLVWK   | When FEAT_DoubleFault2 is implemented and the PE is in Non-debug state, all of the following apply: • If the Effective value of SCTLR2_EL1.NMEA is 1, then the Effective value of SCTLR_EL1.IESB is 1. • If the Effective value of SCTLR2_EL2.NMEA is 1, then the Effective value of SCTLR_EL2.IESB is 1. |
| R RSFMF   | When the PE is in Debug state, the Effective value of SCTLR_ELx.IESB is an IMPLEMENTATION SPECIFIC choice of 0 or 1.                                                                                                                                                                                      |

## D20.5.3.1 Synchronization on exception entry

For each value of ELx in EL1, EL2, EL3' if all of the following are true, then each exception that is taken to ELx generates an Error synchronization event:

- ELx is using AArch64.
- The Effective value of SCTLR\_ELx.IESB is 0b1 .

For each value of ELx in EL1, EL2, EL3, if all of the following are true, then executing a DCPSx instruction generates an Error synchronization event:

- The PE is in Debug state.
- ELx is using AArch64.
- The Effective value of SCTLR\_ELx.IESB is 0b1 .

If an SError exception is taken to the Exception level ELy as a result of the Error synchronization event generated on exception entry by the FEAT\_IESB mechanism, then all the following occur:

- The PE sets the ESR\_ELy.IESB bit in the SError exception syndrome to 0b1 .
- The preferred return address for the SError exception is the exception vector address for the original exception.

Note: ELy might be the same Exception level as ELx.

If SError exceptions are masked at ELx, then any SError exception made pending by the Error synchronization event stays pending.

IMMVJW

IBVBKS

The prioritization of asynchronous exceptions is IMPLEMENTATION DEFINED. This means that an implementation might choose to behave as if the SError exception made pending by the Error synchronization event was taken before the implicit Error synchronization event, if the SError exception was not masked, taking the SError exception in place of the original exception, unless the original exception is also an SError exception.

In this case, ESR\_ELy.IESB is set to 0b0 and the reported PE error state correctly indicates, for instance, whether software can recover execution from the preferred return address for the SError exception in ELR\_ELy.

When FEAT\_DoubleFault is implemented, Arm recommends that an implicit Error synchronization event is inserted before taking an exception to EL3.

When FEAT\_DoubleFault2 is implemented, Arm recommends that an implicit Error synchronization event is inserted before taking an exception to the target Exception level for an SError exception.

## D20.5.3.2 Synchronization on exception return

RSKRCR For each value of ELx in EL1, EL2, EL3, if all of the following are true, then executing an exception return instruction at ELx generates an Error synchronization event:

- The instruction does not generate any exception.
- ELx is using AArch64.
- The Effective value of SCTLR\_ELx.IESB is 0b1 .

IGPPXQ On an illegal return event, the exception return instruction sets PSTATE.IL to 0b1 , which causes the next instruction to generate an Illegal State exception. The exception return instruction does not generate the exception.

RCVPDN

For each value of ELx in EL1, EL2, EL3, if all of the following are true, then executing an DRPS instruction at ELx generates an Error synchronization event:

- The PE is in Debug state and the instruction does not generate any exception.
- ELx is using AArch64.
- The Effective value of SCTLR\_ELx.IESB is 0b1 .

RGXQYD Any SError exception taken as part of the Error synchronization event terminates execution of the instruction.

RLPKVM

IJZHDB

If an SError exception is taken to an Exception level, ELy, as a result of the Error synchronization event generated on exception return by the FEAT\_IESB mechanism, then all the following occur:

- The PE sets the ESR\_ELy.IESB bit in the SError exception syndrome to an IMPLEMENTATION DEFINED choice of 0b0 or 0b1 .
- The preferred return address for the SError exception is the address of the ERET instruction.

If SError exceptions are masked at ELx, then any SError exception made pending by the Error synchronization event stays pending.

## D20.5.4 Error synchronization barriers in a minimal implementation

IGQQCK

IHSHJG

Error synchronization events and the ESB

instruction can be implemented as no-ops if all of the following apply:

- Either there are no sources of SError exceptions, or all SError exceptions are reported as Uncategorized error and are not synchronizable errors.
- Either EL2 is not implemented, or VSESR\_EL2 and VDFSR are implemented as RES0.

This allows for a very low cost implementation of the RAS Extension.

Such an implementation might include FEAT\_IESB, meaning the SCTLR\_ELx.IESB controls have no effect.

See also Syndrome registers.