## D7.4 Memory Encryption Contexts

IQLZZR

The Memory Encryption Contexts Extension (MEC Extension) introduces memory encryption contexts (MECs) to all PA spaces. Multiple memory encryption contexts are provided to the Realm physical address space for assignment to Realm virtual machines, with policy controlled by Realm EL2. The Root, Secure and Non-Secure physical address spaces each have one context.

RLZNNK

All statements in this section and subsections require implementation of FEAT\_MEC.

## D7.4.1 Memory Encryption Context IDs

| I NCBSV   | A Memory Encryption Context ID (MECID) is used to associate a memory access with a MEC.                                                                                                                                                                                |
|-----------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| I TMSCH   | The associated MECis based on the current Security state, Exception level, and translation configuration.                                                                                                                                                              |
| R DWCZM   | AMECisuniquely identified by the tuple of PA space and MECID.                                                                                                                                                                                                          |
| R PNKQV   | All memory accesses, in addition to PA space and PA, are associated with a MECID.                                                                                                                                                                                      |
| I LGNTZ   | Memory accesses associated with a MECID include reads, speculative reads, writes, atomics, instruction fetches and translation table lookups.                                                                                                                          |
| R ZSBJB   | Each PA space has a default MECID, defined as MECID of zero.                                                                                                                                                                                                           |
| I GHVCX   | For PA spaces that support memory encryption, memory accesses associated with the default MECID of zero are encrypted.                                                                                                                                                 |
| R JQXXL   | The Non-secure, Secure, and Root PA address spaces each support only one MEC.                                                                                                                                                                                          |
| R RWTKJ   | Accesses to the Non-secure, Secure, and Root PA spaces are associated with a default MECID of zero.                                                                                                                                                                    |
| R TPDCN   | The Realm PA space supports multiple MECs.                                                                                                                                                                                                                             |
| I RMWYN   | Accesses to the Realm PA space can be associated with multiple MECIDs.                                                                                                                                                                                                 |
| R MWFGC   | For accesses to Realm PA space, a MECID value of 0 is equivalent to the default MECID of zero.                                                                                                                                                                         |
| I KZJFJ   | Each MECID is bound to a cryptographic context for encrypted memory locations. Asingle MECID can be bound to different cryptographic contexts for different resources. For example, multiple memory banks can have dedicated encryption engines with independent keys. |
| I XJZYD   | AMECIDvalue is not a system-global identifier and it must be qualified by a PA space.                                                                                                                                                                                  |
| R TRNQY   | If and how a device interprets the MECID associated with a register read or write is IMPLEMENTATION DEFINED.                                                                                                                                                           |
| I MXBDR   | Devices are not anticipated to be MECID aware.                                                                                                                                                                                                                         |
| I WVTBQ   | The MECIDs are configured in System registers for each supported execution context and translation regime.                                                                                                                                                             |
| I VVJGP   | Software is permitted to manage MECID allocation independently from VMIDand ASID allocation.                                                                                                                                                                           |
|           | D7.4.1.1 MECID width                                                                                                                                                                                                                                                   |
| R WVFDT   | The MECID width is 1 to 16 bits.                                                                                                                                                                                                                                       |
| R RBXBC   | For a PE, the supported MECID has an IMPLEMENTATION DEFINED bit width specified by MECIDR_EL2.MECIDWidthm1.                                                                                                                                                            |

| I QDYKJ   | System components may be integrated that support MECIDs of different widths. The common MECID width is the smallest supported MECID width for the entire system.                                                                                                                                                                                                                                                   |
|-----------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| I BKQHQ   | If the common MECID width is less than the value reported by MECIDR_EL2.MECIDWidthm1, then software should pad the upper bits with zeros.                                                                                                                                                                                                                                                                          |
| I HGBXB   | Because the MECID width has a finite size, MECIDs are expected to be used and re-used during the lifetime of a running system.                                                                                                                                                                                                                                                                                     |
| I QBBQC   | If the MECID associated with a memory access to a location is different than the MECID associated with a copy of the location in a cache, then a MECID mismatch occurs within that cache. AMECIDmismatch can occur as the result of any memory access, including explicit read accesses, explicit write accesses, speculative read accesses, instruction fetches, and translation table lookups.                   |
| I YDGXJ   | MECID mismatches are caused by software mis-configurations, such as: • Multiple translation table mappings to a PA with different associated MECID values. • Insufficient cache maintenance operations when re-assigning MECID values to a granule. • Insufficient TLB maintenance and barriers when updating MECID registers, or MECconfiguration. • Using a common MECID width that is too large for the system. |
| I GWPRT   | If MECIDR_EL2.MECIDWidthm1 is wider than the common MECID width, then all of the following can occur: • The memory system exhibits the behaviors due to a MECID mismatch. • Aliased sets of MECIDs result in non-uniquely-encrypted memory.                                                                                                                                                                        |
| I BLZTF   | Memory accesses with a MECID mismatch can cause either or both data corruption and data leakage across contexts.                                                                                                                                                                                                                                                                                                   |
| I BVDCG   | Recovery from a MECID mismatch requires software to correct the configuration state and perform a clean and invalidate to the PoE for all memory that might have been exposed to the MECID mismatch.                                                                                                                                                                                                               |

## D7.4.2 Memory encryption block size

| I ZQSGL   | The block size that memory encryption engines use to encrypt data depends on the algorithm. Amemory write to a location updates the entire encryption data block.   |
|-----------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| R LTWYZ   | Amemory encryption data block size is not permitted to be larger than the smallest supported translation granule size.                                              |
| I RGMPP   | Two or more memory writes with different MECID values to locations within the same smallest supported translation granule can corrupt the entire granule.           |

## D7.4.3 Restrictions on the effects of speculation

| R KLWFT   | The MECID system registers are associated with the respective translation regime.                                                                                                                                                                                                                                                                                                                                                                                           |
|-----------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| I PMLCM   | The PE does not use configured MECID values from MECID system registers for speculative memory accesses for any translation regime that is out-of-context. For speculative memory accesses, the architecture requires all of the following: • When executing at EL3 or EL2, the PE must not use the registers associated with the EL1&0 translation regime. • When executing at EL3 the PE must not use the registers associated with the EL2 or EL2&0 translation regimes. |