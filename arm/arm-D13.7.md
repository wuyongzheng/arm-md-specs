## D13.7 Event filtering

The PMU can filter events by various combinations of Exception level and Security state. This gives software the flexibility to count events across multiple processes.

## D13.7.1 Filtering by Exception level and Security state

In AArch64 state:

- For each event counter, PMEVTYPER&lt;n&gt;\_EL0 specifies the Exception levels in which the counter counts events Attributable to Exception levels.
- PMCCFILTR\_EL0 specifies the Exception levels in which the cycle counter counts.
- If FEAT\_PMUv3\_ICNTR is implemented, PMICFILTR\_EL0 specifies the Exception levels in which the instruction counter counts.

For an event that is Attributable to an Exception level, in a multithreaded implementation:

- When the Effective value of PMEVTYPER&lt;n&gt;\_EL0.MT is 1, the specified filtering is evaluated using the current Exception level and Security state of the thread to which the event is Attributable. See Example D13-3.
- When the Effective value of PMEVTYPER&lt;n&gt;\_EL0.MT is 0, the event is only counted if it is Attributable to the counting thread, and the filtering is evaluated using the Exception level and Security state of the counting thread.

Example D13-3

Example of the effect of the PMEVTYPER&lt; n &gt;\_EL0.MT control

In a multithreaded implementation, if the Effective value of PMEVTYPER&lt;n&gt;\_EL0.MT is 1 and the value of PMEVTYPER&lt;n&gt;\_EL0.U is 1 on the counting thread, then event counter n does not count events Attributable to EL0 on another thread, even if the counting thread is not executing at EL0.

For each Unattributable event, it is IMPLEMENTATION DEFINED whether the filtering applies. In a multithreaded implementation, if the filtering applies to an Unattributable event, then the filtering is evaluated using the Exception level and Security state of the counting thread.

In AArch32 state, the filtering controls are provided by the PMEVTYPER&lt;n&gt; and PMCCFILTR registers.

For more information, see the individual register descriptions and Multithreaded implementations.

## D13.7.2 Filtering by SVE Streaming mode

RYWWSV

If FEAT\_PMUv3\_SME is implemented, then all of the following apply:

- For each event counter, PMEVTYPER&lt;n&gt;\_EL0.VS specifies whether the counter counts events Attributable to Streaming SVE mode, Non-streaming SVE mode, or either mode.
- PMCCFILTR\_EL0.VS specifies whether the cycle counter counts in Streaming SVE mode, Non-streaming SVE mode, or either mode.
- If FEAT\_PMUv3\_ICNTR is implemented, PMICFILTR\_EL0.VS specifies whether the instruction counter counts in Streaming SVE mode, Non-streaming SVE mode, or either mode.

## D13.7.3 Accuracy of event filtering

For most events, it is acceptable that, during a transition between states, events generated by instructions executed in one state are counted in the other state. The following sections describe the cases where event counts must not be counted in the wrong state:

- Exception-related events.
- Software increment events.

## D13.7.3.1 Exception-related events

The PMU must filter events related to exceptions and exception handling according to the Exception level in which the event occurred. These events are:

- EXC\_TAKEN, Exception taken.
- EXC\_RETURN, Instruction architecturally executed, Condition code check pass, exception return.
- CID\_WRITE\_RETIRED, Instruction architecturally executed, Condition code check pass, write to CONTEXTIDR.
- TTBR\_WRITE\_RETIRED, Instruction architecturally executed, Condition code check pass, write to translation table base.
- EXC\_UNDEF, Exception taken, other synchronous.
- EXC\_SVC, Exception taken, Supervisor Call.
- EXC\_PABORT, Exception taken, Instruction Abort.
- EXC\_DABORT, Exception taken, Data Abort or SError.
- EXC\_IRQ, Exception taken, IRQ.
- EXC\_FIQ, Exception taken, FIQ.
- EXC\_SMC, Exception taken, Secure Monitor Call.
- EXC\_HVC, Exception taken, Hypervisor Call.
- EXC\_TRAP\_PABORT, Exception taken, Instruction Abort not Taken locally.
- EXC\_TRAP\_DABORT, Exception taken, Data Abort or SError not Taken locally.
- EXC\_TRAP\_OTHER, Exception taken, other traps not Taken locally.
- EXC\_TRAP\_IRQ, Exception taken, IRQ not Taken locally.
- BRB\_FILTRATE, Branch record captured.

The PMU must not count an exception after it has been taken because this could systematically report a result of zero exceptions at EL0. Similarly, it is not acceptable for the PMU to count exception returns or writes to CONTEXTIDR after the return from the exception.

If FEAT\_SEBEP is implemented, then when any precise exception is taken, including PMU exceptions, the value of all event counters counting at-retirement events and the instruction counter are precise. See RTNVSL in Definition of a precise exception and imprecise exception.

## D13.7.3.2 Software increment events

The PMU must filter software increment events according to the Exception level in which the software increment occurred. Software increment counting must also be precise, meaning the PMU must count every architecturally executed software increment event, and must not count any Speculatively executed software increment.

If the PE performs two architecturally executed writes to the PMSWINC\_EL0 or PMSWINC register without an intervening Context Synchronization event, then the counter is incremented twice.

For more information, see SW\_INCR.

## D13.7.4 Pseudocode description of event filtering

See CountPMUEvents() in A-profile Architecture Pseudocode for a pseudocode description of event filtering. However, this function does not completely describe the behavior for Unattributable events.