## 3.18 Interrupts and notifications

Events that are recorded to the Event queues, PRI requests and Global errors have associated interrupts to allow asynchronous notification to a PE.

An implementation might support Message Signaled Interrupts (MSIs) which take the form of a 32-bit data write of a configurable value to a configurable location, typically, in GICv3 systems, the GITS\_TRANSLATER or GICD\_SETSPI\_NSR registers. For more information, see [7]. When SMMU\_S\_IDR1.SECURE\_IMPL == 1, Arm expects notifications that were generated by Secure events to set Secure SPIs using the GICD\_SETSPI\_SR register in systems that implement the GICv3 architecture.

An implementation must support one of, or optionally both of, wired interrupts and MSIs. Whether an implementation supports MSIs is discoverable from SMMU\_IDR0.MSI and SMMU\_S\_IDR0.MSI. An implementation might support wired interrupt outputs that are edge-triggered. The discovery of support for wired interrupts is IMPLEMENTATION DEFINED.

Arm recommends that an implementation does not support Secure MSIs without also supporting Non-secure MSIs.

It is not permitted for an interrupt notification of the presence of new information to be observable before the new information is also observable. This applies to MSI and wired interrupts, when:

- A Global error condition arises. The change to the Global error register, GERROR, must be observable if the interrupt is observable.
- New entries are written to an output queue. The presence of the new entries must be observable to reads of the queue index registers if the interrupt is observable. See section 3.5.2 Queue entry visibility semantics .
- A CMD\_SYNC completes. The consumption of the CMD\_SYNC must be observable to reads of the queue index registers if the interrupt is observable.

Each MSI can be independently configured with a memory type and Shareability. This makes it possible to target a Device MSI target register or a location in Normal memory (that might be cached and shareable). See the SMMU\_IDR0.COHACC field, which indicates whether the SMMU and the system support coherent accesses, including MSI writes.

Note: A PE might poll this location or might, for example in Armv8-A PEs, wait for loss of an exclusive reservation that covers an address targeted by the notification. In this example, an Armv8-A PE with an SMMU that is capable of making shared cacheable accesses can achieve the same behavior as a WFE wake-up event notification (see CMD\_SYNC) without wired event signals, using MSIs that are directed at a shared memory location.

Note: If the destination of an MSI write is a register in another device, Arm recommends that it is configured with Device-nGnRnE or Device-nGnRE attributes.

The SMMU does not output inconsistent attributes as a result of misconfiguration. Outer Shareable is used as the effective Shareability when Device or Normal Inner Non-cacheable Outer Non-cacheable types are configured.

MSIs that are generated by Secure sources are performed with Secure accesses and target the Secure PA space. MSIs from Non-secure sources are performed with Non-secure accesses and they target the Non-secure PA space. Apart from the memory type, Shareability and NS attributes of MSIs, all other attributes of the MSI write are IMPLEMENTATION DEFINED.

A GICv3 Interrupt Translation Service (ITS) differentiates interrupt sources using a DeviceID. To support this, the SMMUdoes the following:

- a) Passes StreamIDs of incoming client device transactions. These generate DeviceIDs in a system-specific manner.
- b) Produces a unique DeviceID of its own, one that does not overlap with those produced for client devices, for outgoing MSIs that originate from the SMMU. As with any other MSI-producing Requester, this is set statically in a system-defined manner.

SMMU MSIs are configured with several separate pieces of register state. The MSI destination address, data payload, Shareability, memory type and enables in combination construct the MSI write, onto which the unique DeviceID of the SMMU is attached.

Edge-triggered interrupts can be coalesced within the system interrupt controller. The SMMU can internally coalesce events and identical interrupts so that only the latest interrupt is sent, but any coalescence must not significantly delay the notification. This applies to both MSIs and edge-triggered wired interrupts.

When MSIs are not supported, the interrupt configuration register fields that would configure MSI address and data are unused. Only the interrupt Enable field is used.

## 3.18.1 MSI synchronization

The SMMU ensures that previously-issued MSI writes are completed at the following synchronization points:

- For register-based MSI configuration, the act of disabling an MSI through SMMU\_(*\_)IRQ\_CTRL, see Chapter 6 Memory map and registers .
- A CMD\_SYNC ensures completion of MSIs that originate from the completion of prior CMD\_SYNC commands that were consumed from the same Command queue.

Completion of an MSI guarantees that the MSI write is visible to its Shareability domain or, if an abort response was returned, ensures that the abort is visible in GERROR with the appropriate SMMU\_(*\_)GERROR.MSI\_*\_ABT\_ERR flag.

Note: Completion of an MSI terminated with abort sets a GERROR flag but does not guarantee completion of a subsequent GERROR interrupt that might be raised to signal the setting of the flag.

The two synchronization points define a point in time, t , for the respective interrupt sources. If MSIs are related to occurrences before this point t , they do not become visible after point t .

In the case of register-based MSI configurations, the additional guarantee is made that MSIs triggered after the MSI is re-enabled will use the new configuration.

For more information on interrupt enable and synchronization, see SMMU\_IRQ\_CTRL.

## 3.18.2 Interrupt sources

The SMMU has the following interrupt sources. Depending on the implementation, each interrupt source asserts a wired interrupt output that is unique to the source, or sends an MSI, or both.

| Source                        | Trigger reason                                           | Notes                                                    |
|-------------------------------|----------------------------------------------------------|----------------------------------------------------------|
| Event queue                   | Event queue transitions from empty to non-empty          | -                                                        |
| Secure Event queue            | Event queue transitions from empty to non-empty          | -                                                        |
| PRI queue                     | PRI queue interrupt condition, see SMMU_PRIQ_IRQ_CFG2    | -                                                        |
| Command queue CMD_SYNC        | Sync complete, with option of generated interrupt        | MSI configuration (destination &data) present in command |
| Secure Command queue CMD_SYNC | Sync complete, with option of generated interrupt        | MSI configuration (destination &data) present in command |
| GERROR                        | Global error activated in SMMU_GERROR registers          | -                                                        |
| S_GERROR                      | Secure Global error activated in SMMU_S_GERROR registers | -                                                        |
| Realm Event queue             | Event queue transition from empty to non-empty           | -                                                        |
| Realm PRI queue               | Value of SMMU_R_PRIQ_IRQ_CFG2.LO bit                     | -                                                        |
| Realm Command queue CMD_SYNC  | Sync complete, with option of generated interrupt        | MSI configuration (destination &data) present in command |

| Source       | Trigger reason                                   | Notes   |
|--------------|--------------------------------------------------|---------|
| Realm GERROR | Activation of a Realm GERROR                     | -       |
| GPF_FAR      | An error becomes active in SMMU_ROOT_GPF_FAR     | -       |
| GPT_CFG_FAR  | An error becomes active in SMMU_ROOT_GPT_CFG_FAR | -       |

Each interrupt source can be enabled individually through SMMU\_(*\_)IRQ\_CTRL if present. If enabled, a pulse is asserted on a unique wired interrupt output, if this is implemented. If enabled, an MSI is sent if MSIs are supported and if the MSI configuration of the source enables the sending of an MSI by using an ADDR value that is not zero.

This allows an implementation that supports both MSIs and wired interrupts to use both types concurrently. For example, the Secure programming interface might use wired interrupts (whose source would be enabled, but with the MSI ADDR == 0 to disable MSIs) and the Non-secure programming interface might use MSIs (whose source would be enabled and have MSI address and data configured).

The conditions that cause an interrupt to be triggered are all transient events and interrupt outputs are effectively edge-triggered. There is no facility to reset the pending state of the interrupt sources.

Where an implementation supports RAS features, additional interrupts might be present. The operation, configuration and assertion of these interrupts has no effect on any of the interrupts listed in this section for normal SMMU usage. See Chapter 12 Reliability, Availability and Serviceability (RAS) for more information on RAS features.

An SMMU with RME has two additional wired interrupts. See section 3.25.5 SMMU behavior if a GPC fault is active for details.