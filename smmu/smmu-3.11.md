## 3.11 Reset, Enable and initialization

The SMMU can reset to a disabled state in which traffic bypasses the SMMU without translation or checking of any kind. The SMMU appears transparent to transactions from client devices, which are given attributes according to the disabled bypass configuration (see Chapter 13 Attribute Transformation ). The SMMU can also optionally reset to a disabled state that aborts all transactions for a Security state. This behavior is controlled by the reset state of SMMU\_GBPA.ABORT or SMMU\_S\_GBPA.ABORT.

Note: When an SMMU resets to a bypass configuration, it enables client devices that are connected to an SMMU to be used by legacy system software that lacks awareness of the SMMU.

Translation of Non-secure Streams is enabled using SMMU\_CR0.SMMUEN. When SMMU\_S\_IDR1.SECURE\_IMPL == 1, the Secure programming interface also contains an enable flag, SMMU\_S\_CR0.SMMUEN, which controls translation of Secure streams.

When translation is not enabled for a Security state, an SMMU:

- When SMMU\_(*\_)GBPA.ABORT == 1, aborts all transactions:
- When SMMU\_(S\_)GBPA.ABORT == 0, applies attributes to a transaction as determined by SMMU\_(A)GBPA or SMMU\_S\_(A)GBPA. See section 13.2 SMMU disabled global bypass attributes .
- Never accesses the Stream table so SMMU\_(*\_)STRTAB\_* register content is ignored.
- Denies PRI Page Requests as though SMMU\_(R\_)CR0.PRIQEN == 0, regardless of the value of SMMU\_(R\_)CR0.PRIQEN. See Chapter 8 Page request queue .
- Does not perform ATOS operations. See SMMU\_GATOS\_CTRL.
- Does not perform ATS translations. See section 3.9.1.2 Responses to ATS Translation Requests .
- Allows registers to be accessed and updated in the normal manner.
- Can process commands after the relevant queue pointers are initialized and SMMU\_(*\_)CR0.CMDQEN is enabled.
- Does not record new translation events. However, if SMMU\_(*\_)CR0.EVENTQEN is enabled and the queue pointers are set up, the SMMU might continue to write out buffered events that were generated by earlier translations from when translation was still enabled.

See section 6.3.9.6 SMMUEN for a full description of the operation of, and the effect of changes to, the SMMUEN flag.

The SMMU\_(*\_)STRTAB\_BASE register and the SMMU\_(*\_)CR1 table attributes must be configured before enabling an SMMU interface using SMMU\_(*\_)CR0.SMMUEN.

Note: This avoids the possibility of incoming traffic attempting a lookup through uninitialized configuration structure pointers.

When translation is disabled for a Security state, transactions on streams that are associated with that Security state are not translated, and take attributes from the appropriate Global Bypass Attribute registers, SMMU\_(A)GBPA or SMMU\_S\_(A)GBPA.

When translation is enabled for a Security state, transactions on streams that are associated with that Security state follow the SMMU translation flow determined by the appropriate Stream Table Entry.

|   SMMU_CR0.SMMUEN | SMMU_S_CR0.SMMUEN   | Traffic                                                                                                  |
|-------------------|---------------------|----------------------------------------------------------------------------------------------------------|
|                 0 | Unimplemented       | All traffic bypasses SMMU/aborts (as determined by SMMU_GBPA.ABORT). Always targets Non-secure PA space. |
|                 1 | Unimplemented       | Traffic follows the SMMUtranslation flow. Always targets Non-secure PA space.                            |

|   SMMU_CR0.SMMUEN |   SMMU_S_CR0.SMMUEN | Traffic                                                                                                                                                                                                                                                                                            |
|-------------------|---------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
|                 0 |                   0 | Secure and Non-secure streams are controlled by SMMU_(S_)(A)GBPA. SEC_SID determines the Security state of a given stream. Bypass/abort configuration and attributes, including input NS attribute, are provided by the Global Bypass Attribute register (GBPA) appropriate to the Security state. |
|                 0 |                   1 | SEC_SID determines the Security state: • Secure traffic followsSMMU translation flow. • Non-secure traffic bypasses the SMMU(attributes taken SMMU_GBPA), or aborts.                                                                                                                               |
|                 1 |                   0 | SEC_SID determines Security state: • Secure traffic bypasses theSMMU (attributes taken from SMMU_S_GBPA), or aborts. • Non-secure traffic follows the SMMUtranslation flow.                                                                                                                        |
|                 1 |                   1 | SEC_SID determines the Security state, follows usual SMMUtranslation flow.                                                                                                                                                                                                                         |

The state of the caches and TLBs at reset is IMPLEMENTATION SPECIFIC.

To avoid UNPREDICTABLE behavior, software must perform the following steps before enabling translation:

- Invalidate all configuration and TLB caches.
- When SMMU\_S\_IDR1.SECURE\_IMPL == 1, ensure Secure software fully invalidates any Secure cached configuration or TLB entries in the SMMU through the Secure programming interface before handover to Non-secure software.

The SMMU is not required to invalidate cached configuration or TLB entries when a change to SMMU\_(*\_)CR0.SMMUEN occurs.

Arm recommends that software initializing the SMMU performs the following steps:

1. Allocate and initialize Stream table memory and base pointers.
2. Allocate and initialize Command queue and Event queue memory, base pointers and indexes.
3. Enable command processing through SMMU\_(*\_)CR0.CMDQEN, and if applicable, Event queue through the relevant EVENTQEN.
4. Issue commands to invalidate all cached configuration and TLB entries (see sections 4.3 Configuration structure invalidation and 4.4 TLB invalidation ).
5. Enable translation by setting SMMU\_(*\_)CR0.SMMUEN.

Note: These steps are a summary, and do not show the required register update procedure or DSB operations ensuring correct memory and register access ordering.

SMMU\_S\_INIT invalidates SMMU caches and TLBs without issuing commands using the Command queue. Caches and TLBs are invalidated using this register with the following sequence:

- Perform a write to SMMU\_S\_INIT, setting INV\_ALL.
- Poll SMMU\_S\_INIT.INV\_ALL until it returns to 0, at which point the invalidation is complete.

When SMMU\_S\_IDR1.SECURE\_IMPL == 1, Arm expects Secure software to initialize the SMMU using the steps above. If Secure software is not guaranteed to initialize the SMMU in accordance with the steps above, Arm recommends that the system provides an IMPLEMENTATION DEFINED mechanism to allow Non-secure software to access SMMU\_S\_INIT. This is an exception to the general rule that only Secure software can access SMMU\_S\_* registers.

Note: For example, a system might allow Non-secure access to SMMU\_S\_INIT from reset, but might provide a means for Secure software to disable this access.

Note: Arm expects Non-secure initialization to use SMMU commands to perform configuration cache and TLB invalidation. Non-secure access to SMMU\_S\_INIT is not guaranteed, so the INV\_ALL feature must not be relied on by the Non-secure state.

Note: Invalidation of all Non-secure TLB information can be achieved by issuing CMD\_TLBI\_EL2\_ALL and CMD\_TLBI\_NSNH\_ALL commands.

If an SMMU implementation creates TLB entries when bypass is selected with SMMUEN == 0, these entries are not visible to software. An implementation does not require TLB entries inserted to support transaction bypass to be explicitly invalidated by software, such as when SMMUEN is transitioned from 0 to 1.